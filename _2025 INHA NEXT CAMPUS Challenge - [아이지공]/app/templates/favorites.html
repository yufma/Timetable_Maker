{% extends "base.html" %}
{% block title %}ì°œ ëª©ë¡ | Timetable Recommender{% endblock %}
{% block content %}
<div class="max-w-7xl mx-auto px-4 py-8">
    <div class="mb-6 flex justify-between items-start">
        <div>
            <h1 class="text-3xl font-bold mb-2">ì°œ ëª©ë¡</h1>
            <p class="text-gray-600">ê´€ì‹¬ ìˆëŠ” ê°•ì˜, êµìˆ˜ë‹˜, ì‹œê°„í‘œë¥¼ ì €ì¥í•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”</p>
        </div>
        <a href="/lecture-search" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2">
            <span>ğŸ”</span>
            <span>ê°•ì˜ ê²€ìƒ‰</span>
        </a>
    </div>

    <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
    <div class="mb-6 border-b">
        <div class="flex gap-4">
            <button onclick="showTab('lectures')" id="tab-lectures" class="px-4 py-2 font-semibold border-b-2 border-black text-black">ì°œí•œ ê°•ì˜</button>
            <button onclick="showTab('professors')" id="tab-professors" class="px-4 py-2 font-semibold border-b-2 border-transparent text-gray-500 hover:text-black">ì°œí•œ êµìˆ˜ë‹˜</button>
            <button onclick="showTab('schedules')" id="tab-schedules" class="px-4 py-2 font-semibold border-b-2 border-transparent text-gray-500 hover:text-black">ì°œí•œ ì‹œê°„í‘œ</button>
        </div>
    </div>

    <!-- ì°œí•œ ê°•ì˜ íƒ­ -->
    <div id="content-lectures" class="tab-content">
        <div class="bg-white rounded-xl border p-6">
            {% if favorite_lectures and favorite_lectures|length > 0 %}
                <div class="space-y-4">
                    {% for fav in favorite_lectures %}
                        <div class="border rounded-lg p-4 hover:bg-gray-50 transition-colors">
                            <div class="flex justify-between items-center">
                                <div class="flex-1">
                                    <div class="flex items-center gap-3 mb-2">
                                        <span class="px-3 py-1 bg-gray-100 rounded text-sm font-mono">{{ fav.subject_code }}</span>
                                        {% if fav.display_name %}
                                            <span class="text-lg font-semibold">{{ fav.display_name }}</span>
                                        {% endif %}
                                    </div>
                                    <p class="text-sm text-gray-600 mt-2">ì°œí•œ ë‚ ì§œ: {{ fav.created_at or "ì•Œ ìˆ˜ ì—†ìŒ" }}</p>
                                </div>
                                <div class="flex gap-2">
                                    <a href="/lecture-search/view-summary?code={{ fav.subject_code }}" class="px-3 py-2 bg-gray-600 text-white rounded text-sm hover:bg-gray-700">ìƒì„¸ë³´ê¸°</a>
                                    <button onclick="removeFavorite('lecture', {{ fav.id }}, '{{ fav.subject_code }}')" class="px-3 py-2 bg-red-600 text-white rounded text-sm hover:bg-red-700">ì‚­ì œ</button>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center text-gray-500 py-12">
                    <p class="text-lg mb-2">ì•„ì§ ì°œí•œ ê°•ì˜ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                    <p class="text-sm mb-4">ê°•ì˜ ê²€ìƒ‰ í˜ì´ì§€ì—ì„œ ê°•ì˜ë¥¼ ì°œí•´ë³´ì„¸ìš”.</p>
                    <a href="/lecture-search" class="inline-block px-5 py-2 rounded-xl bg-black text-white hover:bg-gray-800">ê°•ì˜ ê²€ìƒ‰í•˜ê¸°</a>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- ì°œí•œ êµìˆ˜ë‹˜ íƒ­ -->
    <div id="content-professors" class="tab-content hidden">
        <div class="bg-white rounded-xl border p-6">
            {% if favorite_professors and favorite_professors|length > 0 %}
                <div class="space-y-4">
                    {% for fav in favorite_professors %}
                        <div class="border rounded-lg p-4 hover:bg-gray-50 transition-colors">
                            <div class="flex justify-between items-center">
                                <div class="flex-1">
                                    <h3 class="text-lg font-semibold">{{ fav.professor_name }}</h3>
                                    <p class="text-sm text-gray-600 mt-1">ì°œí•œ ë‚ ì§œ: {{ fav.created_at or "ì•Œ ìˆ˜ ì—†ìŒ" }}</p>
                                </div>
                                <div class="flex gap-2">
                                    <a href="/lecture-search?professor={{ fav.professor_name|urlencode }}" class="px-3 py-2 bg-gray-600 text-white rounded text-sm hover:bg-gray-700">ê°•ì˜ ê²€ìƒ‰</a>
                                    <button onclick="removeFavorite('professor', {{ fav.id }}, '{{ fav.professor_name }}')" class="px-3 py-2 bg-red-600 text-white rounded text-sm hover:bg-red-700">ì‚­ì œ</button>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center text-gray-500 py-12">
                    <p class="text-lg mb-2">ì•„ì§ ì°œí•œ êµìˆ˜ë‹˜ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    <p class="text-sm mb-4">ê°•ì˜ ê²€ìƒ‰ í˜ì´ì§€ì—ì„œ êµìˆ˜ë‹˜ì„ ì°œí•´ë³´ì„¸ìš”.</p>
                    <a href="/lecture-search" class="inline-block px-5 py-2 rounded-xl bg-black text-white hover:bg-gray-800">ê°•ì˜ ê²€ìƒ‰í•˜ê¸°</a>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- ì°œí•œ ì‹œê°„í‘œ íƒ­ -->
    <div id="content-schedules" class="tab-content hidden">
        <div class="bg-white rounded-xl border p-6">
            {% if favorite_schedules and favorite_schedules|length > 0 %}
                <div class="space-y-4">
                    {% for fav in favorite_schedules %}
                        <div class="border rounded-lg p-4 hover:bg-gray-50 transition-colors">
                            <div class="flex justify-between items-center">
                                <div class="flex-1">
                                    <h3 class="text-lg font-semibold">{{ fav.schedule_name or "ì´ë¦„ ì—†ëŠ” ì‹œê°„í‘œ" }}</h3>
                                    <p class="text-sm text-gray-600 mt-1">ì°œí•œ ë‚ ì§œ: {{ fav.created_at or "ì•Œ ìˆ˜ ì—†ìŒ" }}</p>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="viewSchedule({{ fav.id }})" class="px-3 py-2 bg-gray-600 text-white rounded text-sm hover:bg-gray-700">ë³´ê¸°</button>
                                    <button onclick="removeFavorite('schedule', {{ fav.id }})" class="px-3 py-2 bg-red-600 text-white rounded text-sm hover:bg-red-700">ì‚­ì œ</button>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center text-gray-500 py-12">
                    <p class="text-lg mb-2">ì•„ì§ ì°œí•œ ì‹œê°„í‘œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                    <p class="text-sm mb-4">ì‹œê°„í‘œ ì¶”ì²œ í˜ì´ì§€ì—ì„œ ì‹œê°„í‘œë¥¼ ì°œí•´ë³´ì„¸ìš”.</p>
                    <a href="/recommend" class="inline-block px-5 py-2 rounded-xl bg-black text-white hover:bg-gray-800">ì‹œê°„í‘œ ì¶”ì²œí•˜ê¸°</a>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let currentTab = 'lectures';

function showTab(tabName) {
    // ëª¨ë“  íƒ­ ì½˜í…ì¸  ìˆ¨ê¸°ê¸°
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
    });
    
    // ëª¨ë“  íƒ­ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
    document.querySelectorAll('[id^="tab-"]').forEach(btn => {
        btn.classList.remove('border-black', 'text-black');
        btn.classList.add('border-transparent', 'text-gray-500');
    });
    
    // ì„ íƒí•œ íƒ­ ì½˜í…ì¸  í‘œì‹œ
    document.getElementById(`content-${tabName}`).classList.remove('hidden');
    
    // ì„ íƒí•œ íƒ­ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì ìš©
    const activeTab = document.getElementById(`tab-${tabName}`);
    activeTab.classList.remove('border-transparent', 'text-gray-500');
    activeTab.classList.add('border-black', 'text-black');
    
    currentTab = tabName;
    
    // íƒ­ ë³€ê²½ ì‹œ ë°ì´í„° ë¡œë“œ (í•„ìš”í•œ ê²½ìš°)
    loadTabData(tabName);
}

function loadTabData(tabName) {
    // íƒ­ ë³€ê²½ ì‹œ ì¶”ê°€ ë°ì´í„° ë¡œë“œê°€ í•„ìš”í•œ ê²½ìš° ì—¬ê¸°ì— êµ¬í˜„
}

       function removeFavorite(type, id, key) {
           if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
               return;
           }
           
           let endpoint = '';
           if (type === 'lecture') {
               endpoint = `/api/favorites/lecture/by-id/${id}`;
           } else if (type === 'professor') {
               endpoint = `/api/favorites/professor/by-id/${id}`;
           } else if (type === 'schedule') {
               // ì‹œê°„í‘œ ì‚­ì œëŠ” ì•„ì§ êµ¬í˜„ë˜ì§€ ì•ŠìŒ
               alert('ì‹œê°„í‘œ ì‚­ì œ ê¸°ëŠ¥ì€ ê³§ êµ¬í˜„ë  ì˜ˆì •ì…ë‹ˆë‹¤.');
               return;
           } else {
               alert('ì•Œ ìˆ˜ ì—†ëŠ” íƒ€ì…ì…ë‹ˆë‹¤.');
               return;
           }
           
           fetch(endpoint, { method: 'DELETE' })
               .then(response => {
                   if (response.status === 401) {
                       alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                       window.location.href = '/login';
                       return null;
                   }
                   return response.json();
               })
               .then(data => {
                   if (data && data.success) {
                       // localStorageì—ì„œë„ í•´ë‹¹ í•­ëª© ì œê±°
                       if (key && (type === 'lecture' || type === 'professor')) {
                           try {
                               const stored = localStorage.getItem('favoriteStatus');
                               if (stored) {
                                   const status = JSON.parse(stored);
                                   if (type === 'lecture') {
                                       status.lectures[key] = false;
                                   } else if (type === 'professor') {
                                       status.professors[key] = false;
                                   }
                                   localStorage.setItem('favoriteStatus', JSON.stringify(status));
                               }
                           } catch (e) {
                               console.error('Error updating localStorage:', e);
                           }
                       }
                       location.reload();
                   } else if (data) {
                       alert(data.message || 'ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                   }
               })
               .catch(error => {
                   console.error('Error:', error);
                   alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
               });
       }

function viewSchedule(id) {
    // TODO: ì‹œê°„í‘œ ìƒì„¸ ë³´ê¸° ê¸°ëŠ¥
    alert('ì‹œê°„í‘œ ë³´ê¸° ê¸°ëŠ¥ì€ ê³§ êµ¬í˜„ë  ì˜ˆì •ì…ë‹ˆë‹¤.');
}

// ì´ˆê¸° ë¡œë“œ
document.addEventListener('DOMContentLoaded', function() {
    showTab('lectures');
});
</script>
{% endblock %}
