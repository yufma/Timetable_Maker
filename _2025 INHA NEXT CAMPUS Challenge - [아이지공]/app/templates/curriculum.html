{% extends "base.html" %}
{% block title %}êµê³¼ê³¼ì •í‘œ ë‹¤ìš´ë¡œë“œ | Timetable Recommender{% endblock %}
{% block content %}
    <div class="mb-6">
        <h1 class="text-3xl font-bold mb-2">êµê³¼ê³¼ì •í‘œ ë‹¤ìš´ë¡œë“œ</h1>
        <p class="text-gray-600">í•™ê³¼ë³„ êµê³¼ê³¼ì •í‘œë¥¼ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”</p>
    </div>

    <!-- êµê³¼ê³¼ì •í‘œ ì„ íƒ -->
    <section class="bg-white rounded-xl border p-6">
        <div class="grid md:grid-cols-2 gap-4 mb-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">í•™ê³¼ ì„ íƒ</label>
                <select id="department-select" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-black focus:border-transparent" onchange="onDepartmentChange()">
                    <option value="">ì „ì²´</option>
                    <option value="ì¸ê³µì§€ëŠ¥ê³µí•™ê³¼">ì¸ê³µì§€ëŠ¥ê³µí•™ê³¼</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">êµê³¼ê³¼ì •í‘œ ì„ íƒ</label>
                <select id="curriculum-select" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-black focus:border-transparent" onchange="onCurriculumChange()">
                    <option value="">ì „ì²´</option>
                </select>
            </div>
        </div>
        <div id="curriculum-results" class="mt-4">
            <!-- ì„ íƒëœ êµê³¼ê³¼ì •í‘œ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
        </div>
    </section>
{% endblock %}

{% block extra_scripts %}
<script>
// í•™ê³¼ ì„ íƒ ì‹œ êµê³¼ê³¼ì •í‘œ ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°
function onDepartmentChange() {
    const department = document.getElementById('department-select').value;
    const curriculumSelect = document.getElementById('curriculum-select');
    const resultsDiv = document.getElementById('curriculum-results');
    
    // êµê³¼ê³¼ì •í‘œ ì„ íƒ ì´ˆê¸°í™” ë° ê²°ê³¼ ì´ˆê¸°í™”
    curriculumSelect.innerHTML = '<option value="">ì „ì²´</option>';
    resultsDiv.innerHTML = '';
    
    if (!department) {
        return;
    }
    
    // í•´ë‹¹ í•™ê³¼ì˜ êµê³¼ê³¼ì •í‘œ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (ì—°ë„ ë¬´ê´€)
    fetch(`/api/curriculum-pdfs?department=${encodeURIComponent(department)}`)
        .then(response => response.json())
        .then(data => {
            data.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                const yearSuffix = item.year ? ` (${item.year}í•™ë…„ë„)` : '';
                option.textContent = `${item.department_name} êµê³¼ê³¼ì •í‘œ${yearSuffix}`;
                curriculumSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error:', error);
        });
}

// êµê³¼ê³¼ì •í‘œ ì„ íƒ ì‹œ ëª©ë¡ í‘œì‹œ
function onCurriculumChange() {
    const curriculumSelect = document.getElementById('curriculum-select').value;
    const department = document.getElementById('department-select').value;
    const resultsDiv = document.getElementById('curriculum-results');
    
    resultsDiv.innerHTML = '';
    
    if (!department || !curriculumSelect) {
        return;
    }
    
    // ì „ì²´ ì„ íƒì´ë©´ ëª¨ë“  êµê³¼ê³¼ì •í‘œ í‘œì‹œ
    if (curriculumSelect === '') {
        fetch(`/api/curriculum-pdfs?department=${encodeURIComponent(department)}`)
            .then(response => response.json())
            .then(data => {
                displayCurriculumResults(data);
            })
            .catch(error => {
                console.error('Error:', error);
            });
    } else {
        // íŠ¹ì • êµê³¼ê³¼ì •í‘œë§Œ í‘œì‹œ
        fetch(`/api/curriculum-pdfs?department=${encodeURIComponent(department)}`)
            .then(response => response.json())
            .then(data => {
                const filtered = data.filter(item => item.id == curriculumSelect);
                displayCurriculumResults(filtered);
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }
}

// êµê³¼ê³¼ì •í‘œ ëª©ë¡ í‘œì‹œ
function displayCurriculumResults(curriculums) {
    const resultsDiv = document.getElementById('curriculum-results');
    
    if (curriculums.length === 0) {
        resultsDiv.innerHTML = '<div class="text-center text-gray-500 py-8">êµê³¼ê³¼ì •í‘œê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
    }
    
    resultsDiv.innerHTML = curriculums.map(item => {
        const yearSuffix = item.year ? `(${item.year}í•™ë…„ë„)` : '';
        return `
            <div class="border rounded-lg p-4 mb-3 hover:bg-gray-50 transition-colors">
                <div class="flex justify-between items-center">
                    <div>
                        <h3 class="font-semibold text-lg">${item.department_name} êµê³¼ê³¼ì •í‘œ ${yearSuffix}</h3>
                        ${item.curriculum_name ? `<p class="text-sm text-gray-600 mt-1">${item.curriculum_name}</p>` : ''}
                    </div>
                    <button onclick="downloadCurriculumPdf(${item.id}, '${item.department_name}', '${item.year || ''}')" 
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">
                        ğŸ“¥ ë‹¤ìš´ë¡œë“œ
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

// êµê³¼ê³¼ì •í‘œ PDF ë‹¤ìš´ë¡œë“œ
function downloadCurriculumPdf(curriculumId, departmentName, year) {
    const pdfUrl = `/api/pdf/department/${encodeURIComponent(departmentName)}?id=${curriculumId}`;
    window.open(pdfUrl, '_blank');
}
</script>
{% endblock %}
