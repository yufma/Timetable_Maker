{% extends "base.html" %}
{% block title %}ê°•ì˜ê²€ìƒ‰ | Timetable Recommender{% endblock %}
{% block content %}
<div class="max-w-7xl mx-auto px-4 py-8">
    <div class="mb-6 flex justify-between items-start">
        <div>
            <h1 class="text-3xl font-bold mb-2">ê°•ì˜ê²€ìƒ‰</h1>
            <p class="text-gray-600">ì›í•˜ëŠ” ê°•ì˜ë¥¼ ê²€ìƒ‰í•˜ê³  ìƒì„¸ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
        </div>
        <a href="/favorites" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 flex items-center gap-2">
            <span>â¤ï¸</span>
            <span>ì°œ ëª©ë¡</span>
        </a>
    </div>

    <!-- ê²€ìƒ‰ ì˜ì—­ -->
    <div class="bg-white rounded-xl border p-6 mb-6">
        <h2 class="text-lg font-semibold mb-4">ê°•ì˜ ê²€ìƒ‰</h2>
        <div class="flex gap-4">
            <div class="flex-1">
                <input type="text" id="lecture-search-input" placeholder="ê°•ì˜ëª… ë˜ëŠ” í•™ìˆ˜ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" 
                       class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-black focus:border-transparent"
                       onkeypress="if(event.key==='Enter') performSearch()">
            </div>
            <button onclick="searchLectures()" class="px-6 py-2 bg-black text-white rounded-lg hover:bg-gray-800">
                ê²€ìƒ‰
            </button>
        </div>
        <div class="mt-4">
            <h3 class="text-sm font-medium text-gray-700 mb-2">êµìˆ˜ëª… ê²€ìƒ‰</h3>
            <div class="flex gap-4">
            <div class="flex-1">
                <input type="text" id="professor-search-input" placeholder="êµìˆ˜ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" 
                       class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-black focus:border-transparent"
                       onkeypress="if(event.key==='Enter') performSearch()">
            </div>
            <button onclick="searchProfessor()" class="px-6 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-800">
                ê²€ìƒ‰
            </button>
            </div>
        </div>
    </div>

    <!-- ê°•ì˜ ëª©ë¡ -->
    <div class="bg-white rounded-xl border p-6">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-semibold">ê°•ì˜ ëª©ë¡</h2>
            <div class="text-sm text-gray-600">
                ì´ <span id="lecture-count">0</span>ê°œ ê°•ì˜
            </div>
        </div>
        <div id="lecture-list" class="space-y-4">
            <!-- ê°•ì˜ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
        </div>
    </div>
</div>

<script>
// URL íŒŒë¼ë¯¸í„°ì—ì„œ professor ê°’ í™•ì¸
const urlParams = new URLSearchParams(window.location.search);
const professorParam = urlParams.get('professor');

// ì´ˆê¸° ê°•ì˜ ëª©ë¡ ë¡œë“œ
window.addEventListener('DOMContentLoaded', function() {
    // URLì— professor íŒŒë¼ë¯¸í„°ê°€ ìˆìœ¼ë©´ í•´ë‹¹ êµìˆ˜ë¡œ ê²€ìƒ‰
    if (professorParam) {
        document.getElementById('professor-search-input').value = professorParam;
        searchByProfessorOnly();
    } else {
        loadAllLectures();
    }
    
    // localStorage ë³€ê²½ ê°ì§€ (ë‹¤ë¥¸ íƒ­ì—ì„œ ì°œ ì‚­ì œ ì‹œ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸)
    window.addEventListener('storage', function(e) {
        if (e.key === 'favoriteStatus') {
            // localStorageê°€ ë³€ê²½ë˜ì—ˆìœ¼ë¯€ë¡œ í•˜íŠ¸ ë²„íŠ¼ ì—…ë°ì´íŠ¸
            updateFavoriteButtonsFromStorage();
        }
    });
});

// localStorageì˜ ì°œ ìƒíƒœë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•˜íŠ¸ ë²„íŠ¼ ì—…ë°ì´íŠ¸
function updateFavoriteButtonsFromStorage() {
    const status = getFavoriteStatusFromStorage();
    
    // ëª¨ë“  ê°•ì˜ ì°œ ë²„íŠ¼ ì—…ë°ì´íŠ¸
    document.querySelectorAll('.favorite-lecture-btn').forEach(btn => {
        const code = btn.getAttribute('data-code');
        if (code && status.lectures.hasOwnProperty(code)) {
            btn.textContent = status.lectures[code] ? 'â¤ï¸' : 'ğŸ¤';
        }
    });
    
    // ëª¨ë“  êµìˆ˜ ì°œ ë²„íŠ¼ ì—…ë°ì´íŠ¸
    document.querySelectorAll('.favorite-professor-btn').forEach(btn => {
        const professor = btn.getAttribute('data-professor');
        if (professor && status.professors.hasOwnProperty(professor)) {
            btn.textContent = status.professors[professor] ? 'â¤ï¸' : 'ğŸ¤';
        }
    });
}

// êµìˆ˜ëª…ë§Œìœ¼ë¡œ ê²€ìƒ‰ (URL íŒŒë¼ë¯¸í„°ìš©)
function searchByProfessorOnly() {
    const professor = document.getElementById('professor-search-input').value.trim();
    
    if (!professor) {
        loadAllLectures();
        return;
    }
    
    fetch(`/api/lectures/search-by-professor?professor=${encodeURIComponent(professor)}`)
        .then(response => response.json())
        .then(data => {
            displayLectures(data);
        })
        .catch(error => {
            console.error('Error:', error);
        });
}

// ê°•ì˜ëª…/í•™ìˆ˜ë²ˆí˜¸ ê²€ìƒ‰
function searchLectures() {
    performSearch();
}

// êµìˆ˜ëª… ê²€ìƒ‰
function searchProfessor() {
    performSearch();
}

// í†µí•© ê²€ìƒ‰ ìˆ˜í–‰ (ê°•ì˜ëª… + êµìˆ˜ëª… ë™ì‹œ ê²€ìƒ‰)
function performSearch() {
    const query = document.getElementById('lecture-search-input').value.trim();
    const professor = document.getElementById('professor-search-input').value.trim();
    
    // ë‘˜ ë‹¤ ë¹„ì–´ìˆìœ¼ë©´ ì „ì²´ ëª©ë¡
    if (!query && !professor) {
        loadAllLectures();
        return;
    }
    
    // ë‘˜ ë‹¤ ìˆìœ¼ë©´ í†µí•© ê²€ìƒ‰ API í˜¸ì¶œ
    if (query && professor) {
        fetch(`/api/lectures/search-advanced?q=${encodeURIComponent(query)}&professor=${encodeURIComponent(professor)}`)
            .then(response => response.json())
            .then(data => {
                displayLectures(data);
            })
            .catch(error => {
                console.error('Error:', error);
            });
        return;
    }
    
    // í•˜ë‚˜ë§Œ ìˆìœ¼ë©´ ê¸°ì¡´ ê²€ìƒ‰ ì‚¬ìš©
    if (query) {
        fetch(`/api/lectures/search?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                displayLectures(data);
            })
            .catch(error => {
                console.error('Error:', error);
            });
    } else if (professor) {
        fetch(`/api/lectures/search-by-professor?professor=${encodeURIComponent(professor)}`)
            .then(response => response.json())
            .then(data => {
                displayLectures(data);
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }
}

// ì „ì²´ ê°•ì˜ ëª©ë¡ ë¡œë“œ
function loadAllLectures() {
    fetch('/api/lectures')
        .then(response => response.json())
        .then(data => {
            displayLectures(data);
        })
        .catch(error => {
            console.error('Error:', error);
        });
}

// ê°•ì˜ ëª©ë¡ í‘œì‹œ
function displayLectures(lectures) {
    const container = document.getElementById('lecture-list');
    const countElement = document.getElementById('lecture-count');
    
    countElement.textContent = lectures.length || 0;
    
    if (!lectures || lectures.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-500 py-8">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
    }
    
    // ë¨¼ì € HTMLë§Œ ìƒì„±
    container.innerHTML = lectures.map(lecture => `
        <div class="border rounded-lg p-4 hover:bg-gray-50 transition-colors" data-code="${lecture.code}">
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <div class="flex items-center gap-3 mb-2">
                        <button onclick="toggleFavoriteLecture('${lecture.code}', this)" 
                                class="favorite-lecture-btn text-2xl transition-colors" 
                                data-code="${lecture.code}"
                                style="background: none; border: none; cursor: pointer; padding: 0; line-height: 1;">
                            ğŸ¤
                        </button>
                        <span class="px-3 py-1 bg-gray-100 rounded text-sm font-mono">${lecture.code}</span>
                        <h3 class="text-lg font-semibold">${lecture.name}</h3>
                    </div>
                    ${lecture.professor ? `
                        <div class="flex items-center gap-2 mb-1">
                            <button onclick="toggleFavoriteProfessor('${lecture.professor}', this)" 
                                    class="favorite-professor-btn text-xl transition-colors" 
                                    data-professor="${lecture.professor}"
                                    style="background: none; border: none; cursor: pointer; padding: 0; line-height: 1;">
                                ğŸ¤
                            </button>
                            <p class="text-sm text-gray-600">êµìˆ˜: ${lecture.professor}</p>
                        </div>
                    ` : ''}
                    ${lecture.credit ? `<p class="text-sm text-gray-600 mb-1">í•™ì : ${lecture.credit}</p>` : ''}
                    ${lecture.schedule_time ? `<p class="text-sm text-gray-600 mb-1">ì‹œê°„: ${lecture.schedule_time}</p>` : ''}
                </div>
                <div class="flex gap-2">
                    ${lecture.has_pdf ? `<a href="/api/pdf/subject/${lecture.code.split('.')[0]}" class="px-3 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700" target="_blank">ê°•ì˜ê³„íšì„œ</a>` : ''}
                    <a href="/lecture-search/view-summary?code=${lecture.code}" class="px-3 py-2 bg-gray-600 text-white rounded text-sm hover:bg-gray-700">ìš”ì•½ë³´ê¸°</a>
                </div>
            </div>
        </div>
    `).join('');
    
    // ë°°ì¹˜ë¡œ ëª¨ë“  ì°œ ìƒíƒœ í™•ì¸
    checkFavoritesBatchStatus(lectures);
}

// localStorageì—ì„œ ì°œ ìƒíƒœ ê´€ë¦¬
function getFavoriteStatusFromStorage() {
    try {
        const stored = localStorage.getItem('favoriteStatus');
        return stored ? JSON.parse(stored) : { lectures: {}, professors: {} };
    } catch (e) {
        return { lectures: {}, professors: {} };
    }
}

function saveFavoriteStatusToStorage(status) {
    try {
        localStorage.setItem('favoriteStatus', JSON.stringify(status));
    } catch (e) {
        console.error('Error saving favorite status to storage:', e);
    }
}

function updateFavoriteStatusInStorage(type, key, isFavorite) {
    const status = getFavoriteStatusFromStorage();
    if (type === 'lecture') {
        status.lectures[key] = isFavorite;
    } else if (type === 'professor') {
        status.professors[key] = isFavorite;
    }
    saveFavoriteStatusToStorage(status);
}

// ë°°ì¹˜ë¡œ ì°œ ìƒíƒœ í™•ì¸ ë° ë²„íŠ¼ ì—…ë°ì´íŠ¸
async function checkFavoritesBatchStatus(lectures) {
    if (!lectures || lectures.length === 0) {
        return;
    }
    
    // ëª¨ë“  ê°•ì˜ ì½”ë“œì™€ êµìˆ˜ëª… ìˆ˜ì§‘
    const subjectCodes = lectures.map(l => l.code).filter(Boolean);
    const professorNames = lectures
        .map(l => l.professor)
        .filter(Boolean)
        .filter((name, index, self) => self.indexOf(name) === index); // ì¤‘ë³µ ì œê±°
    
    if (subjectCodes.length === 0 && professorNames.length === 0) {
        return;
    }
    
    // localStorageì—ì„œ ë¨¼ì € ì°œ ìƒíƒœ í™•ì¸ ë° ì¦‰ì‹œ í‘œì‹œ
    const cachedStatus = getFavoriteStatusFromStorage();
    subjectCodes.forEach(code => {
        const isFavorite = cachedStatus.lectures[code] || false;
        const btn = document.querySelector(`.favorite-lecture-btn[data-code="${code}"]`);
        if (btn) {
            btn.textContent = isFavorite ? 'â¤ï¸' : 'ğŸ¤';
        }
    });
    
    professorNames.forEach(name => {
        const isFavorite = cachedStatus.professors[name] || false;
        const btns = document.querySelectorAll(`.favorite-professor-btn[data-professor="${name}"]`);
        btns.forEach(btn => {
            btn.textContent = isFavorite ? 'â¤ï¸' : 'ğŸ¤';
        });
    });
    
    try {
        // ë°°ì¹˜ API í˜¸ì¶œí•˜ì—¬ ì„œë²„ ìƒíƒœì™€ ë™ê¸°í™”
        const formData = new FormData();
        subjectCodes.forEach(code => formData.append('subject_codes', code));
        professorNames.forEach(name => formData.append('professor_names', name));
        
        const response = await fetch('/api/favorites/batch-status', {
            method: 'POST',
            body: formData
        });
        if (!response.ok) {
            // ë¡œê·¸ì¸í•˜ì§€ ì•Šì•˜ê±°ë‚˜ ì˜¤ë¥˜ ë°œìƒ ì‹œ ìºì‹œëœ ìƒíƒœ ìœ ì§€
            return;
        }
        
        const data = await response.json();
        
        // ì„œë²„ ìƒíƒœë¥¼ localStorageì— ì €ì¥
        saveFavoriteStatusToStorage(data);
        
        // ì„œë²„ ìƒíƒœë¡œ UI ì—…ë°ì´íŠ¸ (ìºì‹œëœ ë°ì´í„°ì™€ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ)
        subjectCodes.forEach(code => {
            const isFavorite = data.lectures[code] || false;
            const btn = document.querySelector(`.favorite-lecture-btn[data-code="${code}"]`);
            if (btn) {
                btn.textContent = isFavorite ? 'â¤ï¸' : 'ğŸ¤';
            }
        });
        
        professorNames.forEach(name => {
            const isFavorite = data.professors[name] || false;
            const btns = document.querySelectorAll(`.favorite-professor-btn[data-professor="${name}"]`);
            btns.forEach(btn => {
                btn.textContent = isFavorite ? 'â¤ï¸' : 'ğŸ¤';
            });
        });
    } catch (error) {
        console.error('Error checking batch favorite status:', error);
        // ì˜¤ë¥˜ ë°œìƒ ì‹œ ìºì‹œëœ ìƒíƒœ ìœ ì§€
    }
}

// ì°œ ìƒíƒœ í™•ì¸ ë° ë²„íŠ¼ ì—…ë°ì´íŠ¸ (ê°œë³„ í˜¸ì¶œìš© - ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
async function checkFavoriteStatus(subjectCode, professorName) {
    // ì´ í•¨ìˆ˜ëŠ” ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•Šì§€ë§Œ í•˜ìœ„ í˜¸í™˜ì„±ì„ ìœ„í•´ ìœ ì§€
    // ë°°ì¹˜ APIë¥¼ ì‚¬ìš©í•˜ë„ë¡ ë³€ê²½ë˜ì—ˆìŒ
}

// ê°•ì˜ ì°œ í† ê¸€
async function toggleFavoriteLecture(subjectCode, button) {
    try {
        const response = await fetch(`/api/favorites/lecture/status/${encodeURIComponent(subjectCode)}`);
        if (response.status === 401) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = '/login';
            return;
        }
        const data = await response.json();
        const isFavorite = data.is_favorite;
        
        let result;
        if (isFavorite) {
            // ì°œ ì·¨ì†Œ
            result = await fetch(`/api/favorites/lecture/${encodeURIComponent(subjectCode)}`, {
                method: 'DELETE'
            });
        } else {
            // ì°œ ì¶”ê°€
            result = await fetch(`/api/favorites/lecture/${encodeURIComponent(subjectCode)}`, {
                method: 'POST'
            });
        }
        
        if (result.status === 401) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = '/login';
            return;
        }
        
        const resultData = await result.json();
        if (resultData.success) {
            const newFavoriteStatus = resultData.is_favorite;
            button.textContent = newFavoriteStatus ? 'â¤ï¸' : 'ğŸ¤';
            // localStorageì— ìƒíƒœ ì €ì¥
            updateFavoriteStatusInStorage('lecture', subjectCode, newFavoriteStatus);
        } else {
            alert(resultData.message || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        console.error('Error toggling favorite:', error);
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// êµìˆ˜ ì°œ í† ê¸€
async function toggleFavoriteProfessor(professorName, button) {
    try {
        const response = await fetch(`/api/favorites/professor/status/${encodeURIComponent(professorName)}`);
        if (response.status === 401) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = '/login';
            return;
        }
        const data = await response.json();
        const isFavorite = data.is_favorite;
        
        let result;
        if (isFavorite) {
            // ì°œ ì·¨ì†Œ
            result = await fetch(`/api/favorites/professor/${encodeURIComponent(professorName)}`, {
                method: 'DELETE'
            });
        } else {
            // ì°œ ì¶”ê°€
            result = await fetch(`/api/favorites/professor/${encodeURIComponent(professorName)}`, {
                method: 'POST'
            });
        }
        
        if (result.status === 401) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = '/login';
            return;
        }
        
        const resultData = await result.json();
        if (resultData.success) {
            const newFavoriteStatus = resultData.is_favorite;
            button.textContent = newFavoriteStatus ? 'â¤ï¸' : 'ğŸ¤';
            // localStorageì— ìƒíƒœ ì €ì¥
            updateFavoriteStatusInStorage('professor', professorName, newFavoriteStatus);
        } else {
            alert(resultData.message || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        console.error('Error toggling professor favorite:', error);
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}
</script>
{% endblock %}

