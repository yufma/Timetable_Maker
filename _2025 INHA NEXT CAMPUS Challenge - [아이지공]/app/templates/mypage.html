{% extends "base.html" %}
{% block title %}ë§ˆì´í˜ì´ì§€ | Timetable Recommender{% endblock %}

{% block content %}
<div class="max-w-xl mx-auto space-y-6">
  <h1 class="text-2xl font-bold">ë§ˆì´í˜ì´ì§€</h1>

  {% if msg %}
    <div class="rounded-lg border border-green-200 bg-green-50 p-3 text-green-800 text-sm">{{ msg }}</div>
  {% endif %}
  {% if err %}
    <div class="rounded-lg border border-red-200 bg-red-50 p-3 text-red-700 text-sm">{{ err }}</div>
  {% endif %}

  <!-- ì½ê¸° ì „ìš© í”„ë¡œí•„ ì¹´ë“œ -->
  <div class="rounded-xl border p-4 space-y-2 bg-white/50">
    <div class="text-sm text-gray-500">í•™ë²ˆ</div>
    <div class="font-medium">{{ user.student_id }}</div>

    <div class="text-sm text-gray-500 mt-3">ì´ë¦„</div>
    <div class="font-medium">{{ user.name }}</div>

    <div class="text-sm text-gray-500 mt-3">ì „ê³µ</div>
    <div class="font-medium">{{ user.major or 'ë¯¸ì„¤ì •' }}</div>
  </div>

  <div class="space-y-3">
    <!-- ì°œëª©ë¡ í˜ì´ì§€ ì´ë™ -->
    <a href="/favorites"
      class="mt-3 inline-block w-full text-center bg-pink-500 text-white py-2 rounded-lg hover:bg-pink-600">
      ì°œëª©ë¡ ê´€ë¦¬
    </a>

    <a href="/me/edit" class="w-full inline-block text-center rounded-lg bg-blue-600 text-white py-2">
      íšŒì› ì •ë³´ ìˆ˜ì •
    </a>
  </div>
</div>

<hr class="my-8"/>

<!-- ìˆ˜ê°•ë‚´ì—­ ê´€ë¦¬ ì„¹ì…˜ -->
<div class="max-w-xl mx-auto mb-8">
  <h2 class="text-xl font-bold mb-4">ğŸ“š ìˆ˜ê°•ë‚´ì—­ ê´€ë¦¬</h2>
  <p class="text-sm text-gray-600 mb-4">
    ì„±ì í‘œ PDFë¥¼ ì—…ë¡œë“œí•˜ë©´ ìë™ìœ¼ë¡œ ìˆ˜ê°•ë‚´ì—­ì„ ë¶„ì„í•˜ì—¬ ì €ì¥í•©ë‹ˆë‹¤.
  </p>

  <div id="transcript-section" class="space-y-4">
    <!-- ë¡œë”© ì¤‘ -->
    <div id="loading-indicator" class="text-center py-4 text-gray-500">
      ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
    </div>

    <!-- ì—…ë¡œë“œ í¼ (ì„±ì í‘œê°€ ì—†ì„ ë•Œ) -->
    <div id="upload-form" class="hidden">
      <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
        <input type="file" id="transcript-file" accept=".pdf" class="hidden">
        <label for="transcript-file" class="cursor-pointer">
          <div class="text-4xl mb-2">ğŸ“„</div>
          <p class="text-sm text-gray-600 mb-2">ì„±ì í‘œ PDF íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</p>
          <button type="button" onclick="document.getElementById('transcript-file').click()" 
                  class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
            íŒŒì¼ ì„ íƒ
          </button>
        </label>
      </div>
      <p class="text-xs text-gray-500 mt-2">â€» PDF íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
    </div>

    <!-- ì„±ì í‘œ ì •ë³´ (ì—…ë¡œë“œ í›„) -->
    <div id="transcript-info" class="hidden">
      <div class="bg-white border rounded-lg p-4 space-y-3">
        <div class="flex justify-between items-start">
          <div>
            <h3 class="font-semibold text-lg mb-2">ì—…ë¡œë“œëœ ì„±ì í‘œ</h3>
            <p class="text-sm text-gray-600" id="transcript-filename">-</p>
            <p class="text-sm text-gray-600" id="transcript-upload-date">-</p>
          </div>
          <button onclick="deleteTranscript()" class="px-3 py-1 bg-red-600 text-white rounded text-sm hover:bg-red-700">
            ì‚­ì œ
          </button>
        </div>
        
        <hr>
        
        <div class="grid grid-cols-2 gap-4">
          <div class="bg-purple-50 rounded p-3">
            <p class="text-xs text-gray-600 mb-1">ì „ê³µí•™ì </p>
            <p class="text-2xl font-bold text-purple-600" id="transcript-major-credits">0/65</p>
          </div>
          <div class="bg-blue-50 rounded p-3">
            <p class="text-xs text-gray-600 mb-1">ì „ì²´í•™ì </p>
            <p class="text-2xl font-bold text-blue-600" id="transcript-total-credits">0/130</p>
          </div>
        </div>
        
        <div>
          <button onclick="toggleCourseList()" class="text-sm text-blue-600 hover:underline">
            <span id="course-list-toggle">â–¶ ìˆ˜ê°• ê³¼ëª© ë³´ê¸°</span> (<span id="course-count">0</span>ê°œ)
          </button>
          <div id="course-list" class="hidden mt-3 max-h-60 overflow-y-auto">
            <table class="w-full text-xs">
              <thead class="bg-gray-100 sticky top-0">
                <tr>
                  <th class="px-2 py-1 text-left">í•™ê¸°</th>
                  <th class="px-2 py-1 text-left">í•™ìˆ˜ë²ˆí˜¸</th>
                  <th class="px-2 py-1 text-left">ê³¼ëª©ëª…</th>
                  <th class="px-2 py-1 text-center">í•™ì </th>
                  <th class="px-2 py-1 text-center">ì„±ì </th>
                </tr>
              </thead>
              <tbody id="course-list-body">
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<hr class="my-8"/>

<div class="max-w-xl mx-auto">
  <h2 class="text-lg font-bold text-red-600">íšŒì› íƒˆí‡´</h2>
  <p class="text-sm text-gray-600 mb-3">
    íšŒì›íƒˆí‡´ë¥¼ ì§„í–‰í•˜ë©´ ê³„ì •ê³¼ ì—°ê´€ëœ ë°ì´í„°ê°€ ì‚­ì œë˜ë©°, ë³µêµ¬ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
  </p>

  <form method="post" action="/me/delete" class="space-y-3"
        onsubmit="return confirm('ì •ë§ íƒˆí‡´í•˜ì‹œê² ì–´ìš”? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');">
    <div>
      <label class="block text-sm font-medium">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
      <input type="password" name="delete_password" class="mt-1 w-full rounded-lg border p-2" required />
    </div>
    <button type="submit" class="w-full rounded-lg bg-red-600 text-white py-2">
      íšŒì›íƒˆí‡´
    </button>
  </form>
</div>

<script>
// ì„±ì í‘œ ê´€ë ¨ JavaScript
let currentTranscript = null;

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì„±ì í‘œ ì¡°íšŒ
window.addEventListener('DOMContentLoaded', loadTranscript);

async function loadTranscript() {
  try {
    const response = await fetch('/api/transcript');
    const result = await response.json();
    
    document.getElementById('loading-indicator').classList.add('hidden');
    
    if (result.success && result.data) {
      currentTranscript = result.data;
      showTranscriptInfo(result.data);
    } else {
      showUploadForm();
    }
  } catch (error) {
    console.error('ì„±ì í‘œ ì¡°íšŒ ì˜¤ë¥˜:', error);
    document.getElementById('loading-indicator').classList.add('hidden');
    showUploadForm();
  }
}

function showUploadForm() {
  document.getElementById('upload-form').classList.remove('hidden');
  document.getElementById('transcript-info').classList.add('hidden');
}

function showTranscriptInfo(data) {
  document.getElementById('upload-form').classList.add('hidden');
  document.getElementById('transcript-info').classList.remove('hidden');
  
  document.getElementById('transcript-filename').textContent = data.filename || '-';
  document.getElementById('transcript-upload-date').textContent = 
    data.upload_date ? `ì—…ë¡œë“œ: ${new Date(data.upload_date).toLocaleDateString('ko-KR')}` : '-';
  
  // ì „ê³µí•™ì  í‘œì‹œ (ì „ê³µí•„ìˆ˜ + ì „ê³µì„ íƒ / 65)
  const majorCredits = data.major_credits || 0;
  document.getElementById('transcript-major-credits').textContent = `${majorCredits}/65`;
  
  // ì „ì²´í•™ì  í‘œì‹œ (ì „ì²´ / 130)
  const totalCredits = data.total_credits || 0;
  document.getElementById('transcript-total-credits').textContent = `${totalCredits}/130`;
  
  document.getElementById('course-count').textContent = data.courses ? data.courses.length : 0;
  
  // ê³¼ëª© ë¦¬ìŠ¤íŠ¸ ìƒì„±
  const courseListBody = document.getElementById('course-list-body');
  courseListBody.innerHTML = '';
  if (data.courses && data.courses.length > 0) {
    data.courses.forEach(course => {
      const row = document.createElement('tr');
      row.className = 'border-b hover:bg-gray-50';
      row.innerHTML = `
        <td class="px-2 py-2">${course.year}-${course.semester}</td>
        <td class="px-2 py-2">${course.course_code}</td>
        <td class="px-2 py-2">${course.course_name}</td>
        <td class="px-2 py-2 text-center">${course.credit}</td>
        <td class="px-2 py-2 text-center font-semibold">${course.grade}</td>
      `;
      courseListBody.appendChild(row);
    });
  }
}

function toggleCourseList() {
  const courseList = document.getElementById('course-list');
  const toggle = document.getElementById('course-list-toggle');
  if (courseList.classList.contains('hidden')) {
    courseList.classList.remove('hidden');
    toggle.textContent = 'â–¼ ìˆ˜ê°• ê³¼ëª© ìˆ¨ê¸°ê¸°';
  } else {
    courseList.classList.add('hidden');
    toggle.textContent = 'â–¶ ìˆ˜ê°• ê³¼ëª© ë³´ê¸°';
  }
}

// íŒŒì¼ ì„ íƒ ì‹œ ìë™ ì—…ë¡œë“œ
document.getElementById('transcript-file').addEventListener('change', async function(e) {
  const file = e.target.files[0];
  if (!file) return;
  
  if (!file.name.toLowerCase().endsWith('.pdf')) {
    alert('PDF íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
    return;
  }
  
  const formData = new FormData();
  formData.append('file', file);
  
  // ì—…ë¡œë“œ ì¤‘ í‘œì‹œ
  document.getElementById('upload-form').innerHTML = `
    <div class="text-center py-8">
      <div class="text-4xl mb-2">â³</div>
      <p class="text-sm text-gray-600">ì—…ë¡œë“œ ì¤‘...</p>
      <p class="text-xs text-gray-500 mt-2">PDFë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
    </div>
  `;
  
  try {
    const response = await fetch('/api/transcript/upload', {
      method: 'POST',
      body: formData
    });
    
    const result = await response.json();
    
    if (result.success) {
      alert(result.message);
      await loadTranscript();
    } else {
      alert(result.message || 'ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      showUploadForm();
      e.target.value = ''; // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
    }
  } catch (error) {
    console.error('ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
    alert('ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    showUploadForm();
    e.target.value = ''; // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
  }
});

async function deleteTranscript() {
  if (!confirm('ì„±ì í‘œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nëª¨ë“  ìˆ˜ê°•ë‚´ì—­ ì •ë³´ê°€ ì‚­ì œë©ë‹ˆë‹¤.')) {
    return;
  }
  
  try {
    const response = await fetch('/api/transcript', {
      method: 'DELETE'
    });
    
    const result = await response.json();
    
    if (result.success) {
      alert(result.message);
      currentTranscript = null;
      showUploadForm();
    } else {
      alert(result.message || 'ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
  } catch (error) {
    console.error('ì‚­ì œ ì˜¤ë¥˜:', error);
    alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
}
</script>

{% endblock %}
