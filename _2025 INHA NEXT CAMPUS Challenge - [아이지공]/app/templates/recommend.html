{% extends "base.html" %}
{% block title %}ì‹œê°„í‘œ ì¶”ì²œ | Timetable Recommender{% endblock %}

{% block content %}
<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
  <!-- Left: Timetable preview -->
  <div class="md:col-span-1">
    <div class="sticky top-4" style="max-height: calc(100vh - 2rem); overflow-y: auto; overflow-x: visible;">
      <!-- ìŠ¤í… ë„¤ë¹„ê²Œì´ì…˜ (ë¯¸ë¦¬ë³´ê¸° ì‹œê°„í‘œ ìœ„ìª½) -->
      <div class="mb-3 flex flex-col justify-center" style="min-height: 3.5rem; overflow-x: visible;">
        <div class="flex items-center" style="width: 100%; gap: 0; min-width: max-content; overflow-x: visible;">
          {% set step_names = {1: "í•™ì  ì„¤ì •", 2: "ì „ê³µí•„ìˆ˜", 3: "ì „ê³µì„ íƒ", 4: "ê¸°ì´ˆ/ì¤‘ì  êµì–‘", 5: "í•µì‹¬êµì–‘", 6: "ì¼ë°˜êµì–‘", 7: "ì‹œê°„í‘œ ê²°ê³¼"} %}
          {% for s in range(1, 8) %}
            {% if s > 1 %}
              <!-- ì—°ê²°ì„ ê³¼ í™”ì‚´í‘œ -->
              <div class="flex items-center flex-shrink-0" style="flex: 1 1 0%; min-width: 0;">
                <div class="h-0.5 flex-1" style="background: {% if step >= s %}{% if step > s %}#3b82f6{% else %}#60a5fa{% endif %}{% else %}#e5e7eb{% endif %};"></div>
                <svg class="flex-shrink-0" width="12" height="12" viewBox="0 0 12 12" style="margin: 0 -2px;">
                  <path d="M0 0 L12 6 L0 12 Z" fill="{% if step > s %}#3b82f6{% elif step == s %}#60a5fa{% else %}#e5e7eb{% endif %}" />
                </svg>
              </div>
            {% endif %}
            <!-- ìŠ¤í… ë²„íŠ¼ -->
            <a href="/recommend?step={{ s }}&semester={{ semester }}" 
               class="flex-shrink-0 flex items-center justify-center w-8 h-8 rounded-full text-xs font-semibold transition-all {% if step == s %}bg-blue-600 text-white shadow-md ring-2 ring-blue-300{% elif step > s %}bg-blue-100 text-blue-700 hover:bg-blue-200 border-2 border-blue-300{% else %}bg-gray-100 text-gray-600 hover:bg-gray-200 border-2 border-gray-300{% endif %}" style="flex-shrink: 0;">
              {{ s }}
            </a>
            {% endfor %}
        </div>
        <!-- ìŠ¤í… ì´ë¦„ í‘œì‹œ -->
        <div class="mt-1 text-xs text-center text-gray-600 font-medium">
          {{ step_names[step] }}
      </div>
    </div>

      <!-- ì‚¬ìš© ì„¤ëª… ì•ˆë‚´ ë°•ìŠ¤ -->
      <div class="mb-4 bg-blue-50 border-l-4 border-blue-500 rounded-lg p-3 shadow-sm">
        <div class="flex items-start">
          <div class="flex-shrink-0">
            <svg class="h-5 w-5 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <div class="ml-2 flex-1">
            <h3 class="text-xs font-semibold text-blue-900 mb-1">ğŸ’¡ ì‚¬ìš© ì•ˆë‚´</h3>
            <div class="text-xs text-blue-800">
              {% if step == 1 %}
                <p><strong>ì´ í•™ì </strong>ì„ ì„¤ì •í•´ì£¼ì„¸ìš”. (16~21í•™ì )</p>
              {% elif step == 2 %}
                <p><strong>ì „ê³µí•„ìˆ˜</strong> ê³¼ëª©ì„ ì„ íƒí•˜ì„¸ìš”.</p>
                <p class="mt-1 text-xs text-blue-700">â€¢ í•™ê¸°ë³„ í•„í„°ë§ ê°€ëŠ¥</p>
              {% elif step == 3 %}
                <p><strong>ì „ê³µì„ íƒ</strong> ê³¼ëª©ì„ ì„ íƒí•˜ì„¸ìš”.</p>
                <p class="mt-1 text-xs text-blue-700">â€¢ ì‹œê°„ ë¯¸ë¦¬ë³´ê¸°ë¡œ ì¶©ëŒ í™•ì¸</p>
              {% elif step == 4 %}
                <p><strong>ê¸°ì´ˆ/ì¤‘ì  êµì–‘</strong>ì„ ì„ íƒí•˜ì„¸ìš”.</p>
                <p class="mt-1 text-xs text-blue-700">â€¢ ê· í˜•ìˆê²Œ ì„ íƒí•˜ì„¸ìš”</p>
              {% elif step == 5 %}
                <p><strong>í•µì‹¬êµì–‘ í•™ì </strong>ì„ ì„¤ì •í•˜ê³  ì„ íƒí•˜ì„¸ìš”.</p>
                <p class="mt-1 text-xs text-blue-700">â€¢ ì˜ì—­ë³„ë¡œ ë‹¤ì–‘í•˜ê²Œ ì„ íƒ</p>
              {% elif step == 6 %}
                <p><strong>ì¼ë°˜êµì–‘</strong>ì„ ì„ íƒí•˜ì„¸ìš”.</p>
                <p class="mt-1 text-xs text-blue-700">â€¢ ì›¹ê°•ì˜ í•„í„° í™œìš© ê°€ëŠ¥</p>
              {% elif step == 7 %}
                <p><strong>ì¶”ì²œ ì‹œê°„í‘œ</strong>ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
                <p class="mt-1 text-xs text-blue-700">â€¢ í´ë¦­í•˜ì—¬ ìƒì„¸ ë‚´ìš© í™•ì¸</p>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <h2 class="font-bold mb-2 text-sm">ë¯¸ë¦¬ë³´ê¸° ì‹œê°„í‘œ</h2>
      <div id="timetable" class="border rounded-xl bg-white overflow-hidden">
        <!-- Header days -->
        <div class="grid grid-cols-6 text-center text-xs font-semibold bg-gray-100 border-b">
          <div class="py-1.5">ì‹œê°„</div>
          <div class="py-1.5">ì›”</div>
          <div class="py-1.5">í™”</div>
          <div class="py-1.5">ìˆ˜</div>
          <div class="py-1.5">ëª©</div>
          <div class="py-1.5">ê¸ˆ</div>
        </div>
        <!-- Body grid -->
        <div class="relative">
          <!-- 9ì‹œ~22ì‹œê¹Œì§€ (13ì‹œê°„, 1ì‹œê°„ ë‹¨ìœ„) -->
          <div class="grid grid-cols-6" style="grid-template-rows: repeat(13, 24px); max-height: 312px; overflow-y: auto;">
            <!-- time labels -->
            {% for i in range(13) %}
              {% set hour = 9 + i %}
              <div class="text-xs text-right pr-2 border-r py-0.5">{{'%02d:00' % hour}}</div>
              {% for d in range(5) %}
                <div class="border-b border-r"></div>
              {% endfor %}
            {% endfor %}
          </div>
          <!-- Preview blocks will be injected here -->
          <div id="preview-layer" class="absolute inset-0 pointer-events-none"></div>
        </div>
        <!-- Web lectures -->
        <div class="border-t p-2 text-xs bg-gray-50">
          <div class="font-semibold">ì›¹ê°•ì˜ (ë¯¸ë¦¬ë³´ê¸°)</div>
          <ul id="web-lectures" class="list-disc pl-5"></ul>
        </div>
      </div>

          </div>
          </div>

  <!-- Right: Step content -->
  <div class="md:col-span-2">
    <!-- ë‹¤ìŒ/ì´ì „ ë²„íŠ¼ê³¼ Step ì œëª©ì„ í•œ ì¤„ì— ë°°ì¹˜ -->
    <div class="flex items-center justify-between mb-1" style="min-height: 3.5rem;">
      <h2 class="font-bold text-lg flex items-center gap-3">
        <span>Step {{ step }}: {{ step_names[step] }}</span>
        {% if step in [2,3,4] %}
        <form method="get" action="/recommend" id="semester-form" class="inline-block">
          <input type="hidden" name="step" value="{{ step }}">
          <select name="semester" id="semester-select" class="border rounded px-2 py-1 text-sm">
            {% for sopt in semesters %}
              <option value="{{sopt}}" {% if semester==sopt %}selected{% endif %}>{{sopt}}</option>
            {% endfor %}
          </select>
        </form>
        {% endif %}
      </h2>
      <div class="flex items-center gap-2">
        <form method="post" action="/recommend/step" id="step-navigation-form" class="flex items-center gap-2">
          <input type="hidden" name="step" value="{{ step }}">
          <input type="hidden" name="semester" value="{{ semester }}">
          {% if step == 1 %}
          <input type="hidden" name="target_credits" id="target_credits_form_top">
          {% else %}
          <input type="hidden" name="selected_fids" id="selected_fids_input_top">
          {% endif %}
          {% if step in [2,3,4,5,6] %}
          <input type="hidden" name="eval_choice" id="eval_choice_form_top">
          <input type="hidden" name="assign_choice" id="assign_choice_form_top">
          <input type="hidden" name="quiz_choice" id="quiz_choice_form_top">
          <input type="hidden" name="credit_choice" id="credit_choice_form_top">
          {% if step in [5,6] %}
          <input type="hidden" name="web_choice" id="web_choice_form_top">
          {% endif %}
          <input type="hidden" name="sort_choice" id="sort_choice_form_top">
          {% endif %}
          {% if step == 1 %}
          <button name="action" value="next" type="submit" onclick="return updateHiddenInputs();" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">ë‹¤ìŒ</button>
          {% elif step == 5 %}
          <button name="action" value="prev" type="submit" onclick="updateHiddenInputs();" class="px-4 py-2 rounded-lg bg-white border hover:bg-gray-50">ì´ì „</button>
          <button name="action" value="next" type="submit" onclick="return validateCoreCredits();" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">ë‹¤ìŒ</button>
          {% elif step == 6 %}
          <button name="action" value="prev" type="submit" onclick="updateHiddenInputs();" class="px-4 py-2 rounded-lg bg-white border hover:bg-gray-50">ì´ì „</button>
          <button name="action" value="next" type="submit" onclick="updateHiddenInputs();" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">ì‹œê°„í‘œ ìƒì„±</button>
          {% elif step == 7 %}
          <button name="action" value="prev" type="submit" onclick="updateHiddenInputs();" class="px-4 py-2 rounded-lg bg-white border hover:bg-gray-50">ì´ì „</button>
          {% else %}
          <button name="action" value="prev" type="submit" onclick="updateHiddenInputs();" class="px-4 py-2 rounded-lg bg-white border hover:bg-gray-50">ì´ì „</button>
          <button name="action" value="next" type="submit" onclick="updateHiddenInputs();" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">ë‹¤ìŒ</button>
          {% endif %}
        </form>
      </div>
    </div>

    {% if step == 1 %}
      <div class="bg-white rounded-xl border p-4">
        <div class="space-y-4">
          <label class="block font-semibold">ê¸ˆí•™ê¸°ì— ì´ìˆ˜í•  í•™ì  (16~21)</label>
          <input type="number" min="16" max="21" id="target_credits_input" value="{{ state.target_credits }}" class="border rounded px-3 py-2 w-40" oninput="validateTargetCredits();" onblur="validateTargetCredits();">
          <div id="target_credits_error" class="text-sm text-red-600 hidden"></div>
          <div class="text-sm text-gray-600">ìƒë‹¨ì˜ 'ë‹¤ìŒ' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
        </div>
      </div>

    {% elif step in [2,3,4,5,6] %}
        <!-- ê²€ìƒ‰ ê¸°ëŠ¥ -->
        <div class="mb-4 bg-white rounded-xl border p-4">
          <label class="text-sm font-semibold mb-2 block">ğŸ” ê³¼ëª© ê²€ìƒ‰</label>
          <div class="flex gap-2">
            <input 
              type="text" 
              id="course_search" 
              placeholder="ê³¼ëª©ëª…, í•™ìˆ˜ë²ˆí˜¸, êµìˆ˜ëª…ìœ¼ë¡œ ê²€ìƒ‰..." 
              class="flex-1 border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
            <button 
              id="clear_search" 
              class="px-3 py-2 border rounded-lg text-sm hover:bg-gray-50"
              title="ê²€ìƒ‰ ì´ˆê¸°í™”"
            >
              âœ•
            </button>
          </div>
          <div class="mt-2 text-xs text-gray-500">
            <span id="search_result_count"></span>
          </div>
        </div>

        <!-- í•„í„° UI ë°•ìŠ¤ -->
        <div class="mb-4 bg-white rounded-xl border p-4">
          <div class="mb-3 grid md:grid-cols-2 gap-2">
            <div>
              <label class="text-sm">í‰ê°€ë°©ì‹</label>
              <select id="eval_choice" class="border rounded px-2 py-1 w-full">
                {% for v in ["ì „ì²´","ìƒëŒ€í‰ê°€","ì ˆëŒ€í‰ê°€","Pass/Fail"] %}
                  <option {% if state.filters.eval==v %}selected{% endif %}>{{v}}</option>
              {% endfor %}
            </select>
          </div>
            <div>
              <label class="text-sm">ê³¼ì œ</label>
              <select id="assign_choice" class="border rounded px-2 py-1 w-full">
                {% for v in ["ì „ì²´","ìœ ","ë¬´"] %}
                  <option {% if state.filters.assign==v %}selected{% endif %}>{{v}}</option>
                {% endfor %}
              </select>
                </div>
            <div>
              <label class="text-sm">í€´ì¦ˆ</label>
              <select id="quiz_choice" class="border rounded px-2 py-1 w-full">
                {% for v in ["ì „ì²´","ìœ ","ë¬´"] %}
                  <option {% if state.filters.quiz==v %}selected{% endif %}>{{v}}</option>
                {% endfor %}
              </select>
              </div>
            <div>
              <label class="text-sm">í•™ì </label>
              <select id="credit_choice" class="border rounded px-2 py-1 w-full">
                {% for v in ["ì „ì²´","1","2","3","4"] %}
                  <option {% if state.filters.credit==v %}selected{% endif %}>{{v}}</option>
            {% endfor %}
              </select>
          </div>
            {% if step in [5,6] %}
            <div>
              <label class="text-sm">ì›¹ê°•</label>
              <select id="web_choice" class="border rounded px-2 py-1 w-full">
                {% for v in ["ì „ì²´","ì›¹ê°•","ì¼ë°˜"] %}
                  <option {% if state.filters.web==v %}selected{% endif %}>{{v}}</option>
                {% endfor %}
              </select>
          </div>
        {% endif %}
            <div>
              <label class="text-sm">ì •ë ¬</label>
              <select id="sort_choice" class="border rounded px-2 py-1 w-full">
                {% for v in ["ê¸°ë³¸ìˆœ","ê³¼ì œ ì ì€ìˆœ","í€´ì¦ˆ ì ì€ìˆœ"] %}
                  <option {% if state.filters.sort==v %}selected{% endif %}>{{v}}</option>
                {% endfor %}
              </select>
          </div>
              </div>
          {% if step == 5 %}
            <form method="post" action="/recommend/step" id="core-credits-form" class="mt-3">
              <input type="hidden" name="step" value="5">
              <input type="hidden" name="semester" value="{{ semester }}">
              <input type="hidden" name="selected_fids" id="selected_fids_core_credits">
              <input type="hidden" name="eval_choice" id="eval_choice_core_credits">
              <input type="hidden" name="assign_choice" id="assign_choice_core_credits">
              <input type="hidden" name="quiz_choice" id="quiz_choice_core_credits">
              <input type="hidden" name="credit_choice" id="credit_choice_core_credits">
              <input type="hidden" name="web_choice" id="web_choice_core_credits">
              <input type="hidden" name="sort_choice" id="sort_choice_core_credits">
              <label class="font-semibold mr-2">í•µì‹¬êµì–‘ í•™ì  ì„¤ì •</label>
              <input type="number" min="0" max="9" name="core_credits" value="{{ state.core_credits if state.core_credits is not none else '' }}" class="border rounded px-2 py-1 w-24">
              <button name="action" value="save" type="submit" onclick="return updateCoreCreditsForm();" class="ml-2 px-3 py-1 rounded border">ì €ì¥</button>
            </form>
          {% endif %}
        </div>

        {% if error_message %}
          <div class="mb-4 p-3 bg-red-50 border border-red-200 rounded text-sm text-red-700">
            {{ error_message }}
          </div>
        {% endif %}

        <!-- ì„ íƒí•œ ê³¼ëª© ë¦¬ìŠ¤íŠ¸ í‘œì‹œ (ë™ì  ì—…ë°ì´íŠ¸ìš©) -->
        {% set step_names_map = {2: "ì „ê³µí•„ìˆ˜", 3: "ì „ê³µì„ íƒ", 4: "ê¸°ì´ˆ/ì¤‘ì  êµì–‘", 5: "í•µì‹¬êµì–‘", 6: "ì¼ë°˜êµì–‘"} %}
        {% if step in [2,3,4,5,6] %}
          <div id="selected-courses-list" class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded selected-courses-list" style="{% if not selected_courses_by_step.get(step_names_map[step]) %}display: none;{% endif %}">
            {% if selected_courses_by_step.get(step_names_map[step]) %}
              <div class="font-semibold text-sm mb-2">{{ step_names_map[step] }} ì„ íƒí•œ ê³¼ëª© ({{ selected_courses_by_step[step_names_map[step]]|length }}ê°œ):</div>
              <div class="space-y-1">
                {% for course in selected_courses_by_step[step_names_map[step]] %}
                  <div class="text-sm text-gray-700">
                    {{ course.course_id }} â€” {{ course.course_name }} ({{ course.prof }}) â€” {{ course.credit }}í•™ì 
            </div>
            {% endfor %}
          </div>
            {% endif %}
          </div>
        {% endif %}

        <!-- ê°•ì˜ ëª©ë¡ UI ë°•ìŠ¤ -->
        <div class="bg-white rounded-xl border p-4">
          <div class="flex justify-end items-center mb-3">
            <button id="reset_btn" class="px-3 py-1 rounded border">ì„ íƒ ì´ˆê¸°í™”</button>
              </div>
          <div id="sections_container" class="space-y-3"></div>
            </div>

    {% elif step == 7 %}
      <div class="bg-white rounded-xl border p-4">
        <h3 class="font-semibold mb-2">ì¶”ì²œ ì‹œê°„í‘œ ê²°ê³¼</h3>
        
        {% if error_message %}
          <div class="mb-4 p-3 bg-red-50 border border-red-200 rounded text-sm text-red-700">
            {{ error_message }}
          </div>
        {% endif %}
        
        <!-- 1. ê°€ì¥ ìœ„: ìƒì„±ëœ ì‹œê°„í‘œ ìˆ˜ í‘œì‹œ -->
        {% if schedules and schedules|length > 0 %}
          <div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
            <div class="font-semibold text-base text-center">
              ì´ <span class="text-blue-700 text-lg">{{ schedules|length }}</span>ê°œì˜ ì‹œê°„í‘œê°€ ì¶”ì²œë˜ì—ˆìŠµë‹ˆë‹¤!
            </div>
          </div>
        {% endif %}
        
        <!-- 2. ì„ íƒí•œ ê³¼ëª© ë¦¬ìŠ¤íŠ¸ ì „ì²´ í‘œì‹œ (AI ì¶”ì²œ ìœ„ì— ë°°ì¹˜) -->
        <div class="mb-4 border-2 border-blue-300 rounded-lg overflow-hidden bg-blue-50 shadow-sm">
          <button onclick="toggleSelectedSummary()" class="w-full p-3 bg-blue-100 hover:bg-blue-200 flex items-center text-left border-b-2 border-blue-300">
            <div class="text-blue-600 transition-transform mr-3 flex-shrink-0 text-base" id="selected-summary-toggle">â–¶</div>
            <div class="font-semibold text-sm text-blue-900">ğŸ“‹ ì„ íƒí•œ ê³¼ëª© ìš”ì•½</div>
          </button>
          <div id="selected-summary-content" class="hidden p-4 bg-blue-50 border-t-2 border-blue-300">
            {% for step_name, courses in selected_courses_by_step.items() %}
              {% if courses %}
                <div class="mb-3 p-2 bg-white rounded border border-blue-200">
                  <div class="font-medium text-sm text-blue-800 mb-1">{{ step_name }} ({{ courses|length }}ê°œ):</div>
                  <div class="ml-4 space-y-1 text-xs text-gray-700">
                    {% for course in courses %}
                      <div class="py-1 border-b border-blue-100 last:border-b-0">{{ course.course_id }} â€” {{ course.course_name }} ({{ course.prof }}) â€” {{ course.credit }}í•™ì </div>
                    {% endfor %}
                  </div>
                </div>
              {% endif %}
            {% endfor %}
          </div>
        </div>
        
        <!-- 3. AI ì¶”ì²œ ì‹œê°„í‘œ ì„¹ì…˜ (Step 7ì¼ ë•Œë§Œ í‘œì‹œ) -->
        {% if step == 7 and schedules and schedules|length > 0 %}
          <!-- AI ì¶”ì²œ ìš”ì²­ ì„¹ì…˜ (AI ì¶”ì²œì´ ì—†ì„ ë•Œ í‘œì‹œ) -->
          {% if not ai_schedules or ai_schedules|length == 0 %}
            <div class="mb-6 border-2 border-purple-400 rounded-xl overflow-hidden bg-purple-50 shadow-lg">
              <div class="p-3 bg-gradient-to-r from-purple-500 to-purple-600 text-white">
                <div class="flex items-center gap-2">
                  <span class="text-lg font-bold">ğŸ¤– AI ì¶”ì²œ</span>
                </div>
              </div>
              
              <!-- í”¼ë“œë°± ì…ë ¥ ì„¹ì…˜ (AI ì¶”ì²œì´ ì—†ì„ ë•Œ) -->
              <div class="p-4 bg-white border-t-2 border-purple-300">
                <div class="mb-3">
                  <textarea 
                    id="ai-feedback-input" 
                    class="w-full p-3 text-sm border border-purple-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 resize-none"
                    rows="4"
                    placeholder="ë¬´ì—‡ì´ë“  ë¶€íƒí•˜ì„¸ìš”"></textarea>
                </div>
                <button 
                  onclick="generateAISchedule()" 
                  class="w-full px-4 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg text-sm font-medium transition-colors shadow-md">
                  âœ¨ AI ì‹œê°„í‘œ ìƒì„±í•˜ê¸°
                </button>
              </div>
            </div>
          {% endif %}
          
          <!-- AI ì¶”ì²œ ì‹œê°„í‘œ í‘œì‹œ (ìƒì„±ëœ ê²½ìš°) - ìƒì„± ë²„íŠ¼ ì•„ë˜ì— í‘œì‹œ -->
          {% if ai_schedules and ai_schedules|length > 0 %}
            <div class="mb-6 border-2 border-purple-400 rounded-xl overflow-hidden bg-purple-50 shadow-lg" id="ai-schedules-container">
              <div class="p-3 bg-gradient-to-r from-purple-500 to-purple-600 text-white">
                <div class="flex items-center gap-2">
                  <span class="text-lg font-bold">ğŸ¤– AI ì¶”ì²œ</span>
                </div>
              </div>
              
              {% for ai_sc in ai_schedules %}
              <div class="border-t-2 border-purple-300">
                <button onclick="toggleAISchedule({{ loop.index0 }})" class="w-full p-3 bg-purple-100 hover:bg-purple-200 flex items-center text-left">
                  <div class="text-purple-600 transition-transform mr-3 flex-shrink-0" id="ai-schedule-toggle-{{ loop.index0 }}">â–¶</div>
                  <div class="flex items-center gap-4 flex-1">
                    <div class="font-semibold text-sm text-purple-900">AI ì¶”ì²œ ì‹œê°„í‘œ</div>
                    <div class="text-xs text-purple-700">
                      ì´ í•™ì : <b>{{ ai_sc.total_credits }}</b>
                      {% if ai_sc.credits_by_category %}
                        {% set cat = ai_sc.credits_by_category %}
                        | ì „ê³µí•„ìˆ˜: {{ cat.get('ì „ê³µí•„ìˆ˜', 0) }}
                        | ì „ê³µì„ íƒ: {{ cat.get('ì „ê³µì„ íƒ', 0) }}
                        | ê¸°ì´ˆ/ì¤‘ì  êµì–‘: {{ cat.get('ê¸°ì´ˆ/ì¤‘ì  êµì–‘', 0) }}
                        | í•µì‹¬êµì–‘: {{ cat.get('í•µì‹¬êµì–‘', 0) }}
                        | ì¼ë°˜êµì–‘: {{ cat.get('ì¼ë°˜êµì–‘', 0) }}
                      {% endif %}
                    </div>
                  </div>
                </button>
                
                <!-- í”¼ë“œë°± ì…ë ¥ ì„¹ì…˜ (í•­ìƒ í‘œì‹œ) -->
                <div class="p-3 bg-purple-50 border-t border-purple-200">
                  <div class="mb-2">
                    <textarea 
                      id="ai-feedback-{{ loop.index0 }}" 
                      class="w-full p-2 text-sm border border-purple-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 resize-none"
                      rows="3"
                      placeholder="ë¬´ì—‡ì´ë“  ë¶€íƒí•˜ì„¸ìš”"></textarea>
                  </div>
                  <button 
                    onclick="refreshAIScheduleWithFeedback({{ loop.index0 }})" 
                    class="w-full px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg text-sm font-medium transition-colors">
                    ğŸ”„ í”¼ë“œë°± ë°˜ì˜í•˜ì—¬ ìƒˆë¡œ ìƒì„±
                  </button>
                </div>
                
               <!-- AI ì‹œê°„í‘œ ë‚´ìš© (í† ê¸€) -->
               <div id="ai-schedule-content-{{ loop.index0 }}" class="hidden p-3 bg-white">
                 <!-- AI ì œì•ˆ í‘œì‹œ (ìˆëŠ” ê²½ìš°) -->
                 {% if ai_sc.ai_suggestion %}
                   <div class="mb-4 p-3 bg-blue-50 border-l-4 border-blue-400 rounded-lg">
                     <div class="flex items-start">
                       <div class="flex-shrink-0">
                         <svg class="h-5 w-5 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                         </svg>
                       </div>
                       <div class="ml-2 flex-1">
                         <h4 class="text-sm font-semibold text-blue-900 mb-1">ğŸ’¡ AI ì¶”ì²œ ì œì•ˆ</h4>
                         <div class="text-sm text-blue-800 whitespace-pre-line">{{ ai_sc.ai_suggestion }}</div>
                       </div>
                     </div>
                   </div>
                 {% endif %}
                 
                 <div class="grid grid-cols-6 text-center text-xs font-semibold bg-purple-100 border-b rounded-t">
                   <div class="py-2">ì‹œê°„</div>
                   <div class="py-2">ì›”</div>
                   <div class="py-2">í™”</div>
                   <div class="py-2">ìˆ˜</div>
                   <div class="py-2">ëª©</div>
                   <div class="py-2">ê¸ˆ</div>
                 </div>
                  <div class="relative">
                    <div class="grid grid-cols-6" style="grid-template-rows: repeat(13, 40px); max-height: 520px; overflow-y: auto;">
                      {% for i in range(13) %}
                        {% set hour = 9 + i %}
                        <div class="text-xs text-right pr-2 border-r py-1.5">{{'%02d:00' % hour}}</div>
                        {% for d in range(5) %}
                          <div class="border-b border-r"></div>
                        {% endfor %}
                      {% endfor %}
                    </div>
                    <div class="absolute inset-0 ai-schedule-layer" style="max-height: 520px; overflow-y: auto;">
                      {% for s in ai_sc.sections %}
                        {% for mt in s.meetings %}
                          {% set day = mt[0] %}
                          {% set sslot = mt[1] %}
                          {% set eslot = mt[2] %}
                          <div class="slot absolute rounded text-white p-2 overflow-hidden"
                               data-day="{{ day }}"
                               data-sslot="{{ sslot }}"
                               data-eslot="{{ eslot }}"
                               style="box-sizing: border-box;">
                            <div class="font-semibold text-xs leading-tight mb-1">{{ s.course_name }}</div>
                            <div class="opacity-90 text-xs leading-tight">{{ s.course_id }}</div>
                          </div>
                        {% endfor %}
                      {% endfor %}
                    </div>
                  </div>
                  <div class="mt-2 text-xs">
                    <div class="font-semibold">ì›¹ê°•ì˜</div>
                    <ul class="list-disc pl-5">
                      {% for s in ai_sc.sections if s.is_web %}
                        <li>{{ s.course_name }} ({{ s.course_id }}) â€” {{ s.prof }} â€” {{ s.credit }}í•™ì </li>
                      {% endfor %}
                    </ul>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
          {% endif %}
        {% endif %}
        
        <!-- 3. ëª¨ë“  ì‹œê°„í‘œë¥¼ í† ê¸€ í˜•ì‹ìœ¼ë¡œ ë‚˜ì—´ -->
        {% if schedules and schedules|length > 0 %}
          <div class="space-y-4">
            {% for sc in schedules %}
              <div class="rounded-xl border overflow-hidden">
                <!-- ì‹œê°„í‘œ í—¤ë” (í† ê¸€ ë²„íŠ¼) -->
                <button onclick="toggleSchedule({{ loop.index0 }})" class="w-full p-3 bg-gray-50 hover:bg-gray-100 flex items-center text-left">
                  <div class="text-gray-500 transition-transform mr-3 flex-shrink-0" id="schedule-toggle-{{ loop.index0 }}">â–¶</div>
                  <div class="flex items-center gap-4 flex-1">
                    <div class="font-semibold text-sm">ì‹œê°„í‘œ {{ loop.index }}</div>
                    <div class="text-xs text-gray-600">
                      ì´ í•™ì : <b>{{ sc.total_credits }}</b>
                      {% if sc.credits_by_category %}
                        {% set cat = sc.credits_by_category %}
                        | ì „ê³µí•„ìˆ˜: {{ cat.get('ì „ê³µí•„ìˆ˜', 0) }}
                        | ì „ê³µì„ íƒ: {{ cat.get('ì „ê³µì„ íƒ', 0) }}
                        | ê¸°ì´ˆ/ì¤‘ì  êµì–‘: {{ cat.get('ê¸°ì´ˆ/ì¤‘ì  êµì–‘', 0) }}
                        | í•µì‹¬êµì–‘: {{ cat.get('í•µì‹¬êµì–‘', 0) }}
                        | ì¼ë°˜êµì–‘: {{ cat.get('ì¼ë°˜êµì–‘', 0) }}
                      {% endif %}
          </div>
                  </div>
                </button>
                
                <!-- ì‹œê°„í‘œ ë‚´ìš© (í† ê¸€) -->
                <div id="schedule-content-{{ loop.index0 }}" class="hidden p-3">
                  <div class="grid grid-cols-6 text-center text-xs font-semibold bg-gray-100 border-b rounded-t">
                    <div class="py-2">ì‹œê°„</div>
                    <div class="py-2">ì›”</div>
                    <div class="py-2">í™”</div>
                    <div class="py-2">ìˆ˜</div>
                    <div class="py-2">ëª©</div>
                    <div class="py-2">ê¸ˆ</div>
                  </div>
                  <div class="relative">
                    <div class="grid grid-cols-6" style="grid-template-rows: repeat(13, 40px); max-height: 520px; overflow-y: auto;">
                      {% for i in range(13) %}
                        {% set hour = 9 + i %}
                        <div class="text-xs text-right pr-2 border-r py-1.5">{{'%02d:00' % hour}}</div>
                        {% for d in range(5) %}
                          <div class="border-b border-r"></div>
                        {% endfor %}
                      {% endfor %}
                    </div>
                    <div class="absolute inset-0 schedule-layer" style="max-height: 520px; overflow-y: auto;">
                      {% for s in sc.sections %}
                        {% for mt in s.meetings %}
                          {% set day = mt[0] %}
                          {% set sslot = mt[1] %}
                          {% set eslot = mt[2] %}
                          <div class="slot absolute rounded text-white p-2 overflow-hidden"
                               data-day="{{ day }}"
                               data-sslot="{{ sslot }}"
                               data-eslot="{{ eslot }}"
                               style="box-sizing: border-box;">
                            <div class="font-semibold text-xs leading-tight mb-1">{{ s.course_name }}</div>
                            <div class="opacity-90 text-xs leading-tight">{{ s.course_id }}</div>
                          </div>
                        {% endfor %}
                      {% endfor %}
                    </div>
                  </div>
                  <div class="mt-2 text-xs">
                    <div class="font-semibold">ì›¹ê°•ì˜</div>
                    <ul class="list-disc pl-5">
                      {% for s in sc.sections if s.is_web %}
                        <li>{{ s.course_name }} ({{ s.course_id }}) â€” {{ s.prof }} â€” {{ s.credit }}í•™ì </li>
                      {% endfor %}
                    </ul>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="p-4 bg-yellow-50 border rounded">ì¡°ê±´ì— ë§ëŠ” ì‹œê°„í‘œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
        {% endif %}
      </div>
    {% endif %}
    </div>
  </div>

<!-- JSON bootstrap to avoid Jinja-in-JS issues -->
<script id="bootstrap-json" type="application/json">
{
  "step": {{ step|int }},
  "semester": "{{ semester }}",
  "stateSelected": {{ state.selected_sections|tojson }}{% if step in [2,3,4,5,6] %},
  "courseIds": {{ (courses|map(attribute='í•™ìˆ˜ë²ˆí˜¸')|list)|tojson }},
  "selectedCoursesByStep": {{ selected_courses_by_step|tojson }}{% endif %}{% if step == 5 %},
  "coreMap": {{ core_map|tojson }},
  "coreCredits": {{ state.core_credits|tojson if state.core_credits else 'null' }}{% endif %}
}
</script>

  <script>
// --- State (client-side) ---
const BOOTSTRAP = JSON.parse(document.getElementById("bootstrap-json").textContent);
const STEP = BOOTSTRAP.step;
const STEP_KEY = {2:"p1",3:"p2",4:"p3",5:"p4",6:"p5"}[STEP] || null;
const selectedFids = new Set((STEP_KEY && BOOTSTRAP.stateSelected[STEP_KEY]) ? BOOTSTRAP.stateSelected[STEP_KEY] : []);
// ì„ íƒí•œ ìˆœì„œë¥¼ ì¶”ì í•˜ëŠ” ë°°ì—´ (í•„í„°ì™€ ê´€ê³„ì—†ì´ ì„ íƒí•œ ìˆœì„œ ìœ ì§€)
const selectedFidsOrder = (STEP_KEY && BOOTSTRAP.stateSelected[STEP_KEY]) ? [...BOOTSTRAP.stateSelected[STEP_KEY]] : [];

function validateTargetCredits() {
  const input = document.getElementById("target_credits_input");
  const errorDiv = document.getElementById("target_credits_error");
  if (!input || !errorDiv) return;
  
  const val = parseInt(input.value);
  if (isNaN(val) || val < 16 || val > 21) {
    errorDiv.textContent = "í•™ì ì€ 16~21 ì‚¬ì´ì˜ ê°’ë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.";
    errorDiv.classList.remove("hidden");
    input.classList.add("border-red-500");
    return false;
  } else {
    errorDiv.classList.add("hidden");
    input.classList.remove("border-red-500");
    return true;
  }
}

function updateHiddenInputs() {
  // Step 1ì¸ ê²½ìš° target_credits ê°’ ì„¤ì • ë° ê²€ì¦
  if (STEP === 1) {
    if (!validateTargetCredits()) {
      return false; // ê²€ì¦ ì‹¤íŒ¨ ì‹œ í¼ ì œì¶œ ë°©ì§€
    }
    const targetCreditsInput = document.getElementById("target_credits_input");
    const targetCreditsForm = document.getElementById("target_credits_form_top");
    if (targetCreditsInput && targetCreditsForm) {
      const val = targetCreditsInput.value || "16";
      targetCreditsForm.value = val;
      targetCreditsForm.setAttribute("value", val);
    }
    return true;
  }
  
  // Step 2-6ì¸ ê²½ìš° ì„ íƒëœ ê³¼ëª©ê³¼ í•„í„° ê°’ ì„¤ì •
  const selectedStr = Array.from(selectedFids).join(",");
  const selectedInput = document.getElementById("selected_fids_input_top");
  if (selectedInput) {
    selectedInput.setAttribute("value", selectedStr);
    selectedInput.value = selectedStr;
  }
  
  const evalSel = document.getElementById("eval_choice");
  const assignSel = document.getElementById("assign_choice");
  const quizSel = document.getElementById("quiz_choice");
  const creditSel = document.getElementById("credit_choice");
  const webSel = document.getElementById("web_choice");
  const sortSel = document.getElementById("sort_choice");
  
  const evalInput = document.getElementById("eval_choice_form_top");
  const assignInput = document.getElementById("assign_choice_form_top");
  const quizInput = document.getElementById("quiz_choice_form_top");
  const creditInput = document.getElementById("credit_choice_form_top");
  const webInput = document.getElementById("web_choice_form_top");
  const sortInput = document.getElementById("sort_choice_form_top");
  
  if (evalSel && evalInput) {
    const val = evalSel.value || "ì „ì²´";
    evalInput.value = val;
    evalInput.setAttribute("value", val);
  }
  if (assignSel && assignInput) {
    const val = assignSel.value || "ì „ì²´";
    assignInput.value = val;
    assignInput.setAttribute("value", val);
  }
  if (quizSel && quizInput) {
    const val = quizSel.value || "ì „ì²´";
    quizInput.value = val;
    quizInput.setAttribute("value", val);
  }
  if (creditSel && creditInput) {
    const val = creditSel.value || "ì „ì²´";
    creditInput.value = val;
    creditInput.setAttribute("value", val);
  }
  if (webSel && webInput) {
    const val = webSel.value || "ì „ì²´";
    webInput.value = val;
    webInput.setAttribute("value", val);
  }
  if (sortSel && sortInput) {
    const val = sortSel.value || "ê¸°ë³¸ìˆœ";
    sortInput.value = val;
    sortInput.setAttribute("value", val);
  }
}

function validateCoreCredits() {
  const coreCreditsInput = document.querySelector('#core-credits-form input[name="core_credits"]');
  if (!coreCreditsInput || coreCreditsInput.value === null || coreCreditsInput.value === undefined || coreCreditsInput.value.trim() === '') {
    alert('í•µì‹¬êµì–‘ í•™ì ì„ ì„¤ì •í•´ì£¼ì„¸ìš”.');
    return false;
  }
  const val = parseInt(coreCreditsInput.value);
  if (isNaN(val) || val < 0 || val > 9) {
    alert('í•µì‹¬êµì–‘ í•™ì ì€ 0~9 ì‚¬ì´ì˜ ê°’ì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
    return false;
  }
  updateHiddenInputs();
  return true;
}

// í•µì‹¬êµì–‘ í•™ì  ì„¤ì • í¼ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
function updateCoreCreditsForm() {
  // í•µì‹¬êµì–‘ í•™ì  ì…ë ¥ê°’ í™•ì¸
  const coreCreditsInput = document.querySelector('#core-credits-form input[name="core_credits"]');
  if (!coreCreditsInput || coreCreditsInput.value === null || coreCreditsInput.value === undefined || coreCreditsInput.value.trim() === "") {
    alert("í•µì‹¬êµì–‘ í•™ì ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    return false; // í¼ ì œì¶œ ë°©ì§€
  }
  
  const coreCreditsValue = parseInt(coreCreditsInput.value);
  if (isNaN(coreCreditsValue) || coreCreditsValue < 0 || coreCreditsValue > 9) {
    alert("í•µì‹¬êµì–‘ í•™ì ì€ 0~9 ì‚¬ì´ì˜ ê°’ì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
    return false; // í¼ ì œì¶œ ë°©ì§€
  }
  
  // ì„ íƒëœ ê³¼ëª© ì—…ë°ì´íŠ¸
  const selectedStr = Array.from(selectedFids).join(",");
  const selectedInput = document.getElementById("selected_fids_core_credits");
  if (selectedInput) {
    selectedInput.setAttribute("value", selectedStr);
    selectedInput.value = selectedStr;
  }
  
  // í•„í„° ê°’ ì—…ë°ì´íŠ¸
  const evalSel = document.getElementById("eval_choice");
  const assignSel = document.getElementById("assign_choice");
  const quizSel = document.getElementById("quiz_choice");
  const creditSel = document.getElementById("credit_choice");
  const webSel = document.getElementById("web_choice");
  const sortSel = document.getElementById("sort_choice");
  
  const evalInput = document.getElementById("eval_choice_core_credits");
  const assignInput = document.getElementById("assign_choice_core_credits");
  const quizInput = document.getElementById("quiz_choice_core_credits");
  const creditInput = document.getElementById("credit_choice_core_credits");
  const webInput = document.getElementById("web_choice_core_credits");
  const sortInput = document.getElementById("sort_choice_core_credits");
  
  if (evalSel && evalInput) {
    const val = evalSel.value || "ì „ì²´";
    evalInput.value = val;
    evalInput.setAttribute("value", val);
  }
  if (assignSel && assignInput) {
    const val = assignSel.value || "ì „ì²´";
    assignInput.value = val;
    assignInput.setAttribute("value", val);
  }
  if (quizSel && quizInput) {
    const val = quizSel.value || "ì „ì²´";
    quizInput.value = val;
    quizInput.setAttribute("value", val);
  }
  if (creditSel && creditInput) {
    const val = creditSel.value || "ì „ì²´";
    creditInput.value = val;
    creditInput.setAttribute("value", val);
  }
  if (webSel && webInput) {
    const val = webSel.value || "ì „ì²´";
    webInput.value = val;
    webInput.setAttribute("value", val);
  }
  if (sortSel && sortInput) {
    const val = sortSel.value || "ê¸°ë³¸ìˆœ";
    sortInput.value = val;
    sortInput.setAttribute("value", val);
  }
  
  // í•µì‹¬êµì–‘ í•™ì  ì„¤ì •ê°’ ì—…ë°ì´íŠ¸ (BOOTSTRAPì— ë°˜ì˜)
  if (coreCreditsInput && coreCreditsInput.value) {
    BOOTSTRAP.coreCredits = parseInt(coreCreditsInput.value) || null;
  }
  
  return true; // í¼ ì œì¶œ í—ˆìš©
}

// Timetable preview renderer
let currentPreviewFileId = null; // í˜„ì¬ ë¯¸ë¦¬ë³´ê¸° ì¤‘ì¸ file_id ì¶”ì 

function clearPreview() {
  const layer = document.getElementById("preview-layer");
  layer.innerHTML = "";
  document.getElementById("web-lectures").innerHTML = "";
  currentPreviewFileId = null;
}

function renderBlock(dayIdx, startSlot, endSlot, label) {
  const layer = document.getElementById("preview-layer");
  // 30ë¶„ ë‹¨ìœ„ ìŠ¬ë¡¯ì„ 1ì‹œê°„ ë‹¨ìœ„ë¡œ ë³€í™˜ (ìŠ¬ë¡¯ 1-2 = 1ì‹œê°„, 3-4 = 2ì‹œê°„ ë“±)
  // startSlotê³¼ endSlotì„ 1ì‹œê°„ ë‹¨ìœ„ë¡œ ë³€í™˜
  const startHourSlot = Math.ceil((startSlot - 1) / 2) + 1; // 1-2 -> 1, 3-4 -> 2
  const endHourSlot = Math.ceil((endSlot - 1) / 2) + 1;
  const slotHeight = 24; // 1ì‹œê°„ ë‹¨ìœ„ ë†’ì´
  const top = (startHourSlot - 1) * slotHeight;
  const height = (endHourSlot - startHourSlot) * slotHeight;
  const el = document.createElement("div");
  el.className = "absolute rounded text-xs text-white p-0.5 overflow-hidden";
  el.style.left = `calc((100%/6) * ${dayIdx+1})`;
  el.style.width = "calc(100%/6)";
  el.style.top = `${top}px`;
  el.style.height = `${height}px`;
  el.style.background = "rgba(16,185,129,0.9)";
  el.style.fontSize = "10px";
  el.textContent = label;
  layer.appendChild(el);
}

function renderPreview(section) {
  clearPreview();
  if (section.is_web) {
    const li = document.createElement("li");
    li.textContent = `${section.course_name} (${section.course_id}) â€” ì›¹ê°•ì˜`;
    document.getElementById("web-lectures").appendChild(li);
  }
  (section.meetings || []).forEach(mt => {
    const [day, sslot, eslot, room] = mt;
    renderBlock(day, sslot, eslot, `${section.course_name}`);
  });
}

// previewSection function (for compatibility with planner ìƒìˆ˜ version)
function previewSection(fileId, meetings, credit, isWeb) {
  clearPreview();
  if (isWeb) {
    const li = document.createElement("li");
    li.textContent = `ì›¹ê°•ì˜ (${fileId})`;
    document.getElementById("web-lectures").appendChild(li);
  }
  (meetings || []).forEach(mt => {
    const [day, sslot, eslot, room] = mt;
    renderBlock(day, sslot, eslot, fileId);
  });
}

// Fetch and render sections
async function loadSections() {
  // ê¸°ì¡´ ì„ íƒ ìƒíƒœ ì €ì¥
  const previousSelected = new Set(selectedFids);
  
  const evalVal = document.getElementById("eval_choice")?.value || "ì „ì²´";
  const assignVal = document.getElementById("assign_choice")?.value || "ì „ì²´";
  const quizVal = document.getElementById("quiz_choice")?.value || "ì „ì²´";
  const creditVal = document.getElementById("credit_choice")?.value || "ì „ì²´";
  const webVal = document.getElementById("web_choice")?.value || "ì „ì²´";
  const sortVal = document.getElementById("sort_choice")?.value || "ê¸°ë³¸ìˆœ";

  let courseIds = Array.isArray(BOOTSTRAP.courseIds) ? BOOTSTRAP.courseIds.filter(Boolean) : [];
  if (courseIds.length === 0) {
    document.getElementById("sections_container").innerHTML =
      '<div class="p-3 bg-gray-50 border rounded">í‘œì‹œí•  ê³¼ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }

  const form = new FormData();
  form.append("course_ids", courseIds.join(","));
  form.append("eval_choice", evalVal);
  form.append("assign_choice", assignVal);
  form.append("quiz_choice", quizVal);
  form.append("credit_choice", creditVal);
  if (STEP === 6) {
    form.append("web_choice", webVal);
  }
  form.append("sort_choice", sortVal);

  const res = await fetch("/recommend/sections", {method: "POST", body: form});
  const data = await res.json();
  const sections = data.sections || [];

  const cont = document.getElementById("sections_container");
  cont.innerHTML = "";
  if (sections.length === 0) {
    cont.innerHTML = '<div class="p-3 bg-yellow-50 border rounded">ì¡°ê±´ì— ë§ëŠ” ë¶„ë°˜ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }

  // ë¶„ë°˜ë³„ë¡œ ë³„ë„ í‘œì‹œ (ê·¸ë£¹í™”í•˜ì§€ ì•ŠìŒ)
  sections.forEach(sec => {
    const row = document.createElement("div");
    row.className = "py-3 px-2 border-b last:border-b-0 flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-3 border rounded-lg p-3 shadow-sm";
    row.setAttribute("data-file-id", sec.file_id);
    row.setAttribute("data-course-id", sec.course_id);
    row.setAttribute("data-course-name", sec.course_name);
    row.setAttribute("data-prof", sec.prof || "");
    row.setAttribute("data-credit", sec.credit || "");

    const left = document.createElement("div");
    left.className = "flex-1";
    
    // ê°•ì˜ ê²€ìƒ‰ í˜ì´ì§€ ìŠ¤íƒ€ì¼: í•™ìˆ˜ë²ˆí˜¸ì™€ ê³¼ëª©ëª… ë¨¼ì € í‘œì‹œ
    const header = document.createElement("div");
    header.className = "flex items-center gap-3 mb-2";
    
    const toggleBtn = document.createElement("button");
    toggleBtn.className = "text-gray-500 hover:text-gray-700 transition-transform cursor-pointer w-5 h-5 flex items-center justify-center flex-shrink-0";
    toggleBtn.innerHTML = "â–¶";
    toggleBtn.style.transform = "rotate(0deg)";
    toggleBtn.style.transition = "transform 0.2s";
    
    // file_idì—ì„œ ì „ì²´ í•™ìˆ˜ë²ˆí˜¸ ì¶”ì¶œ (ë¶„ë°˜ í¬í•¨: AIE1002.001.json -> AIE1002.001)
    let fullCourseId = sec.course_id;
    if (sec.file_id) {
      // file_idëŠ” "AIE1002.001.json" í˜•ì‹
      const parts = sec.file_id.split(".");
      if (parts.length >= 2) {
        // parts[0] = "AIE1002", parts[1] = "001", parts[2] = "json"
        fullCourseId = `${parts[0]}.${parts[1]}`; // AIE1002.001
      }
    }
    
    const codeSpan = document.createElement("span");
    codeSpan.className = "px-3 py-1 bg-gray-100 rounded text-sm font-mono";
    codeSpan.textContent = fullCourseId;
    
    // ë¶„ë°˜ ì •ë³´ ì¶”ì¶œ (file_idì—ì„œ ì¶”ì¶œ: AIE1002.001.json -> 001)
    let sectionInfo = "";
    if (sec.file_id) {
      const parts = sec.file_id.split(".");
      if (parts.length >= 2) {
        // parts[0] = "AIE1002", parts[1] = "001", parts[2] = "json"
        sectionInfo = `-${parts[1]}`; // "ë¶„ë°˜" ë‹¨ì–´ ì œê±°
      }
    }
    
    const nameH3 = document.createElement("h3");
    nameH3.className = "text-lg font-semibold flex-1";
    nameH3.textContent = sectionInfo ? `${sec.course_name}${sectionInfo}` : sec.course_name;
    
    header.appendChild(toggleBtn);
    header.appendChild(codeSpan);
    header.appendChild(nameH3);
      
      // ìƒì„¸ ì •ë³´ (êµìˆ˜, í•™ì , ì‹œê°„)
      const detailsDiv = document.createElement("div");
      detailsDiv.className = "text-sm text-gray-600 space-y-1 mb-2";
      if (sec.prof) {
        const profP = document.createElement("p");
        profP.textContent = `êµìˆ˜: ${sec.prof}`;
        detailsDiv.appendChild(profP);
      }
      if (sec.credit) {
        const creditP = document.createElement("p");
        creditP.textContent = `í•™ì : ${sec.credit}`;
        detailsDiv.appendChild(creditP);
      }
      
      let __loc = "";
      let __tstr = sec.is_web ? "ì›¹ê°•ì˜" : "ë¯¸ì •";
      if (sec.time_raw) {
        const __i = sec.time_raw.indexOf(":");
        if (__i >= 0) {
          __loc = sec.time_raw.slice(0, __i).trim();
          __tstr = sec.time_raw.slice(__i + 1).trim();
      } else {
          __tstr = (sec.time_raw || "").trim();
        }
      }
      if (__tstr) {
        const timeP = document.createElement("p");
        timeP.textContent = `ì‹œê°„: ${__loc ? `${__loc} / ` : ""}${__tstr}`;
        detailsDiv.appendChild(timeP);
      }
      
      // ìš”ì•½ë³¸ ì»¨í…Œì´ë„ˆ (ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€) - ê°•ì˜ê³„íšì„œ ë‹¤ìš´ë¡œë“œì™€ ìš”ì•½ë³´ê¸° ë²„íŠ¼ í¬í•¨
      const summaryDiv = document.createElement("div");
      summaryDiv.className = "hidden mt-3 p-4 bg-gray-50 rounded-lg border border-gray-200";
      summaryDiv.id = `summary-${sec.course_id}-${sec.file_id}`;
      
      // ê°•ì˜ê³„íšì„œ ë‹¤ìš´ë¡œë“œ ë° ìš”ì•½ë³´ê¸° ë²„íŠ¼
      const actionButtons = document.createElement("div");
      actionButtons.className = "flex gap-2 mb-3";
      const baseCode = sec.course_id.split('.')[0];
      
      // ê°•ì˜ê³„íšì„œ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼
      const pdfBtn = document.createElement("a");
      pdfBtn.href = `/api/pdf/subject/${baseCode}`;
      pdfBtn.target = "_blank";
      pdfBtn.className = "px-3 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700";
      pdfBtn.textContent = "ê°•ì˜ê³„íšì„œ";
      
      // ìš”ì•½ë³´ê¸° ë²„íŠ¼
      const summaryBtn = document.createElement("a");
      summaryBtn.href = `/lecture-search/view-summary?code=${sec.course_id}&from=recommend`;
      summaryBtn.className = "px-3 py-2 bg-gray-600 text-white rounded text-sm hover:bg-gray-700";
      summaryBtn.textContent = "ìš”ì•½ë³´ê¸°";
      
      actionButtons.appendChild(pdfBtn);
      actionButtons.appendChild(summaryBtn);
      
      // ìš”ì•½ë³¸ ë‚´ìš© ì˜ì—­ì€ í‘œì‹œí•˜ì§€ ì•ŠìŒ (ë²„íŠ¼ë§Œ í‘œì‹œ)
      
      summaryDiv.appendChild(actionButtons);
      
      // í† ê¸€ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
      let isExpanded = false;
      toggleBtn.addEventListener("click", async (e) => {
        e.preventDefault();
        isExpanded = !isExpanded;
        
        if (isExpanded) {
          toggleBtn.style.transform = "rotate(90deg)";
          summaryDiv.classList.remove("hidden");
        } else {
          toggleBtn.style.transform = "rotate(0deg)";
          summaryDiv.classList.add("hidden");
        }
      });
      
      // ì‹œê°„ ë¯¸ë¦¬ë³´ê¸°ì™€ ì„ íƒ ë²„íŠ¼ì„ ê³ ì • ìœ„ì¹˜ì— ë°°ì¹˜ (ìƒë‹¨ì— ìœ„ì¹˜)
      const right = document.createElement("div");
      right.className = "flex items-center gap-2 flex-shrink-0";

      const previewBtn = document.createElement("button");
      previewBtn.className = "px-3 py-1 rounded border text-sm";
      previewBtn.textContent = "ì‹œê°„ ë¯¸ë¦¬ë³´ê¸°";
      previewBtn.addEventListener("click", (e)=>{
        e.preventDefault();
        // ê°™ì€ ë²„íŠ¼ì„ ë‹¤ì‹œ ëˆ„ë¥´ë©´ ë¯¸ë¦¬ë³´ê¸° ì œê±°
        if (currentPreviewFileId === sec.file_id) {
          clearPreview();
        } else {
          renderPreview(sec);
          currentPreviewFileId = sec.file_id;
        }
      });

      const pickBtn = document.createElement("button");
      function refreshPickBtn() {
        const picked = selectedFids.has(sec.file_id);
        pickBtn.textContent = picked ? "ì„ íƒë¨" : "ì„ íƒ";
        pickBtn.className = picked ? "px-3 py-1 rounded bg-blue-600 text-white text-sm" : "px-3 py-1 rounded border text-sm bg-white";
      }
      refreshPickBtn();
      pickBtn.addEventListener("click", (e)=>{
        e.preventDefault();
        if (selectedFids.has(sec.file_id)) {
          selectedFids.delete(sec.file_id);
          // ì„ íƒ ìˆœì„œ ë°°ì—´ì—ì„œë„ ì œê±°
          const index = selectedFidsOrder.indexOf(sec.file_id);
          if (index > -1) {
            selectedFidsOrder.splice(index, 1);
          }
        } else {
          selectedFids.add(sec.file_id);
          // ì„ íƒ ìˆœì„œ ë°°ì—´ì— ì¶”ê°€ (ë§ˆì§€ë§‰ì— ì¶”ê°€í•˜ì—¬ ì„ íƒí•œ ìˆœì„œ ìœ ì§€)
          if (!selectedFidsOrder.includes(sec.file_id)) {
            selectedFidsOrder.push(sec.file_id);
          }
        }
        refreshPickBtn();
        updateHiddenInputs();
        updateSelectedList();
      });

      right.appendChild(previewBtn);
      right.appendChild(pickBtn);

      // í—¤ë”ì— ë²„íŠ¼ ì¶”ê°€ (ìƒë‹¨ ê³ ì •)
      header.appendChild(toggleBtn);
      header.appendChild(codeSpan);
      header.appendChild(nameH3);
      header.appendChild(right);
      
      left.appendChild(header);
      left.appendChild(detailsDiv);
      left.appendChild(summaryDiv);
      
      row.appendChild(left);
      cont.appendChild(row);
  });
  
  // ê¸°ì¡´ ì„ íƒ ìƒíƒœ ë³µì›
  previousSelected.forEach(fileId => {
    // selectedFidsì— ì¶”ê°€ (ì—†ìœ¼ë©´ ì¶”ê°€) - DOMì— ì—†ì–´ë„ ì„ íƒ ìƒíƒœ ìœ ì§€
    if (!selectedFids.has(fileId)) {
      selectedFids.add(fileId);
      // ì„ íƒ ìˆœì„œ ë°°ì—´ì—ë„ ì¶”ê°€ (ì—†ëŠ” ê²½ìš°ì—ë§Œ)
      if (!selectedFidsOrder.includes(fileId)) {
        selectedFidsOrder.push(fileId);
      }
    }
    
    const row = cont.querySelector(`[data-file-id="${fileId}"]`);
    if (row) {
      const pickBtn = row.querySelector('button[class*="ì„ íƒ"]');
      if (pickBtn) {
        pickBtn.textContent = "ì„ íƒë¨";
        pickBtn.className = "px-3 py-1 rounded bg-blue-600 text-white text-sm";
      }
    }
  });
  
  // ì„ íƒ ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ (ì§€ì—° í˜¸ì¶œë¡œ DOM ë Œë”ë§ ì™„ë£Œ í›„ ì—…ë°ì´íŠ¸)
  // ì¼ë°˜êµì–‘ ìŠ¤í…ì—ì„œëŠ” í•„í„° ë³€ê²½ê³¼ ê´€ê³„ì—†ì´ í•­ìƒ ì„ íƒ ë¦¬ìŠ¤íŠ¸ í‘œì‹œ
  setTimeout(() => {
    updateSelectedList();
    // ì„ íƒ ë¦¬ìŠ¤íŠ¸ê°€ í•­ìƒ ë³´ì´ë„ë¡ ê°•ì œ í‘œì‹œ
    const listContainer = document.getElementById('selected-courses-list');
    if (listContainer && selectedFids.size > 0) {
      listContainer.style.display = 'block';
    }
    // ê²€ìƒ‰ í•„í„° ë‹¤ì‹œ ì ìš©
    if (typeof searchCourses === 'function') {
      searchCourses();
    }
  }, 100);
}

// === Step5: Core categories (í•µì‹¬êµì–‘1~6) toggle UI ===
async function loadCoreCategory(cat) {
  // ê¸°ì¡´ ì„ íƒ ìƒíƒœ ì €ì¥
  const previousSelected = new Set(selectedFids);
  
  const evalVal = document.getElementById("eval_choice")?.value || "ì „ì²´";
  const assignVal = document.getElementById("assign_choice")?.value || "ì „ì²´";
  const quizVal = document.getElementById("quiz_choice")?.value || "ì „ì²´";
  const creditVal = document.getElementById("credit_choice")?.value || "ì „ì²´";
  const webVal = document.getElementById("web_choice")?.value || "ì „ì²´";
  const sortVal = document.getElementById("sort_choice")?.value || "ê¸°ë³¸ìˆœ";

  const map = BOOTSTRAP.coreMap || {};
  const ids = (map[String(cat)] || map[cat] || []).filter(Boolean);
  const body = document.getElementById(`core-body-${cat}`);
  if (!body) return;
  body.innerHTML = '<div class="p-2 text-sm text-gray-500">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

  if (ids.length === 0) {
    body.innerHTML = '<div class="p-3 bg-gray-50 border rounded">í‘œì‹œí•  ê³¼ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
          return;
        }

  const form = new FormData();
  form.append("course_ids", ids.join(","));
  form.append("eval_choice", evalVal);
  form.append("assign_choice", assignVal);
  form.append("quiz_choice", quizVal);
  form.append("credit_choice", creditVal);
  if (STEP === 5) {
    form.append("web_choice", webVal);
  }
  form.append("sort_choice", sortVal);

  const res = await fetch("/recommend/sections", {method: "POST", body: form});
  const data = await res.json();
  const sections = Array.isArray(data.sections) ? data.sections : [];

  if (sections.length === 0) {
    body.innerHTML = '<div class="p-3 bg-yellow-50 border rounded">ì¡°ê±´ì— ë§ëŠ” ë¶„ë°˜ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
          return;
        }

  // ë¶„ë°˜ë³„ë¡œ ë³„ë„ í‘œì‹œ (ê·¸ë£¹í™”í•˜ì§€ ì•ŠìŒ)
  const cont = document.createElement("div");
  cont.className = "space-y-3";

  sections.forEach(sec => {
    const row = document.createElement("div");
    row.className = "py-3 px-2 border-b last:border-b-0 flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-3 border rounded-lg p-3 shadow-sm";
    row.setAttribute("data-file-id", sec.file_id);
    row.setAttribute("data-course-id", sec.course_id);
    row.setAttribute("data-course-name", sec.course_name);
    row.setAttribute("data-prof", sec.prof || "");
    row.setAttribute("data-credit", sec.credit || "");

      const left = document.createElement("div");
      left.className = "flex-1";
      
      // ê°•ì˜ ê²€ìƒ‰ í˜ì´ì§€ ìŠ¤íƒ€ì¼: í•™ìˆ˜ë²ˆí˜¸ì™€ ê³¼ëª©ëª… ë¨¼ì € í‘œì‹œ
      const header = document.createElement("div");
      header.className = "flex items-center gap-3 mb-2";
      
      const toggleBtn = document.createElement("button");
      toggleBtn.className = "text-gray-500 hover:text-gray-700 transition-transform cursor-pointer w-5 h-5 flex items-center justify-center flex-shrink-0";
      toggleBtn.innerHTML = "â–¶";
      toggleBtn.style.transform = "rotate(0deg)";
      toggleBtn.style.transition = "transform 0.2s";
      
      // file_idì—ì„œ ì „ì²´ í•™ìˆ˜ë²ˆí˜¸ ì¶”ì¶œ (ë¶„ë°˜ í¬í•¨: AIE1002.001.json -> AIE1002.001)
      let fullCourseId = sec.course_id;
      if (sec.file_id) {
        // file_idëŠ” "AIE1002.001.json" í˜•ì‹
        const parts = sec.file_id.split(".");
        if (parts.length >= 2) {
          // parts[0] = "AIE1002", parts[1] = "001", parts[2] = "json"
          fullCourseId = `${parts[0]}.${parts[1]}`; // AIE1002.001
        }
      }
      
      const codeSpan = document.createElement("span");
      codeSpan.className = "px-3 py-1 bg-gray-100 rounded text-sm font-mono";
      codeSpan.textContent = fullCourseId;
      
      // ë¶„ë°˜ ì •ë³´ ì¶”ì¶œ (file_idì—ì„œ ì¶”ì¶œ: AIE1002.001.json -> 001)
      let sectionInfo = "";
      if (sec.file_id) {
        const parts = sec.file_id.split(".");
        if (parts.length >= 2) {
          // parts[0] = "AIE1002", parts[1] = "001", parts[2] = "json"
          sectionInfo = `-${parts[1]}`; // "ë¶„ë°˜" ë‹¨ì–´ ì œê±°
        }
      }
      
      const nameH3 = document.createElement("h3");
      nameH3.className = "text-lg font-semibold flex-1";
      nameH3.textContent = sectionInfo ? `${sec.course_name}${sectionInfo}` : sec.course_name;
      
      // ì‹œê°„ ë¯¸ë¦¬ë³´ê¸°ì™€ ì„ íƒ ë²„íŠ¼ì„ ê³ ì • ìœ„ì¹˜ì— ë°°ì¹˜ (ìƒë‹¨ì— ìœ„ì¹˜)
      const right = document.createElement("div");
      right.className = "flex items-center gap-2 flex-shrink-0";

      const previewBtn = document.createElement("button");
      previewBtn.className = "px-3 py-1 rounded border text-sm";
      previewBtn.textContent = "ì‹œê°„ ë¯¸ë¦¬ë³´ê¸°";
      previewBtn.addEventListener("click", (e)=>{
        e.preventDefault();
        // ê°™ì€ ë²„íŠ¼ì„ ë‹¤ì‹œ ëˆ„ë¥´ë©´ ë¯¸ë¦¬ë³´ê¸° ì œê±°
        if (currentPreviewFileId === sec.file_id) {
          clearPreview();
        } else {
          previewSection(sec.file_id, sec.meetings, sec.credit, sec.is_web);
          currentPreviewFileId = sec.file_id;
        }
      });

      const pickBtn = document.createElement("button");
      function refreshPickBtn() {
        const picked = selectedFids.has(sec.file_id);
        pickBtn.textContent = picked ? "ì„ íƒë¨" : "ì„ íƒ";
        pickBtn.className = picked ? "px-3 py-1 rounded bg-blue-600 text-white text-sm" : "px-3 py-1 rounded border text-sm bg-white";
      }
      refreshPickBtn();
      pickBtn.addEventListener("click", (e)=>{
        e.preventDefault();
        if (selectedFids.has(sec.file_id)) {
          selectedFids.delete(sec.file_id);
          // ì„ íƒ ìˆœì„œ ë°°ì—´ì—ì„œë„ ì œê±°
          const index = selectedFidsOrder.indexOf(sec.file_id);
          if (index > -1) {
            selectedFidsOrder.splice(index, 1);
          }
        } else {
          selectedFids.add(sec.file_id);
          // ì„ íƒ ìˆœì„œ ë°°ì—´ì— ì¶”ê°€ (ë§ˆì§€ë§‰ì— ì¶”ê°€í•˜ì—¬ ì„ íƒí•œ ìˆœì„œ ìœ ì§€)
          if (!selectedFidsOrder.includes(sec.file_id)) {
            selectedFidsOrder.push(sec.file_id);
          }
        }
        refreshPickBtn();
        updateHiddenInputs();
        updateSelectedList();
      });

      right.appendChild(previewBtn);
      right.appendChild(pickBtn);
      
      // í—¤ë”ì— ë²„íŠ¼ ì¶”ê°€ (ìƒë‹¨ ê³ ì •)
      header.appendChild(toggleBtn);
      header.appendChild(codeSpan);
      header.appendChild(nameH3);
      header.appendChild(right);
      
      // ìƒì„¸ ì •ë³´ (êµìˆ˜, í•™ì , ì‹œê°„)
      const detailsDiv = document.createElement("div");
      detailsDiv.className = "text-sm text-gray-600 space-y-1 mb-2";
      if (sec.prof) {
        const profP = document.createElement("p");
        profP.textContent = `êµìˆ˜: ${sec.prof}`;
        detailsDiv.appendChild(profP);
      }
      if (sec.credit) {
        const creditP = document.createElement("p");
        creditP.textContent = `í•™ì : ${sec.credit}`;
        detailsDiv.appendChild(creditP);
      }
      
      let loc = "";
      let tstr = sec.is_web ? "ì›¹ê°•ì˜" : "ë¯¸ì •";
      if (sec.time_raw) {
        const i = sec.time_raw.indexOf(":");
        if (i >= 0) {
          loc = sec.time_raw.slice(0, i).trim();
          tstr = sec.time_raw.slice(i + 1).trim();
        } else {
          tstr = sec.time_raw.trim();
        }
      }
      if (tstr) {
        const timeP = document.createElement("p");
        timeP.textContent = `ì‹œê°„: ${loc ? `${loc} / ` : ""}${tstr}`;
        detailsDiv.appendChild(timeP);
      }
      
      // ìš”ì•½ë³¸ ì»¨í…Œì´ë„ˆ (ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€) - ê°•ì˜ê³„íšì„œ ë‹¤ìš´ë¡œë“œì™€ ìš”ì•½ë³´ê¸° ë²„íŠ¼ í¬í•¨
      const summaryDiv = document.createElement("div");
      summaryDiv.className = "hidden mt-3 p-4 bg-gray-50 rounded-lg border border-gray-200";
      summaryDiv.id = `summary-${sec.course_id}-${sec.file_id}`;
      
      // ê°•ì˜ê³„íšì„œ ë‹¤ìš´ë¡œë“œ ë° ìš”ì•½ë³´ê¸° ë²„íŠ¼
      const actionButtons = document.createElement("div");
      actionButtons.className = "flex gap-2 mb-3";
      const baseCode = sec.course_id.split('.')[0];
      
      // ê°•ì˜ê³„íšì„œ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼
      const pdfBtn = document.createElement("a");
      pdfBtn.href = `/api/pdf/subject/${baseCode}`;
      pdfBtn.target = "_blank";
      pdfBtn.className = "px-3 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700";
      pdfBtn.textContent = "ê°•ì˜ê³„íšì„œ";
      
      // ìš”ì•½ë³´ê¸° ë²„íŠ¼
      const summaryBtn = document.createElement("a");
      summaryBtn.href = `/lecture-search/view-summary?code=${sec.course_id}&from=recommend`;
      summaryBtn.className = "px-3 py-2 bg-gray-600 text-white rounded text-sm hover:bg-gray-700";
      summaryBtn.textContent = "ìš”ì•½ë³´ê¸°";
      
      actionButtons.appendChild(pdfBtn);
      actionButtons.appendChild(summaryBtn);
      
      // ìš”ì•½ë³¸ ë‚´ìš© ì˜ì—­ì€ í‘œì‹œí•˜ì§€ ì•ŠìŒ (ë²„íŠ¼ë§Œ í‘œì‹œ)
      
      summaryDiv.appendChild(actionButtons);
      
      // í† ê¸€ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
      let isExpanded = false;
      toggleBtn.addEventListener("click", async (e) => {
        e.preventDefault();
        isExpanded = !isExpanded;
        
        if (isExpanded) {
          toggleBtn.style.transform = "rotate(90deg)";
          summaryDiv.classList.remove("hidden");
        } else {
          toggleBtn.style.transform = "rotate(0deg)";
          summaryDiv.classList.add("hidden");
        }
      });
      
      left.appendChild(header);
      left.appendChild(detailsDiv);
      left.appendChild(summaryDiv);

      row.appendChild(left);
      cont.appendChild(row);
  });

  body.innerHTML = "";
  body.appendChild(cont);
  
  // ê¸°ì¡´ ì„ íƒ ìƒíƒœ ë³µì›
  previousSelected.forEach(fileId => {
    // selectedFidsì— ì¶”ê°€ (ì—†ìœ¼ë©´ ì¶”ê°€) - DOMì— ì—†ì–´ë„ ì„ íƒ ìƒíƒœ ìœ ì§€
    if (!selectedFids.has(fileId)) {
      selectedFids.add(fileId);
      // ì„ íƒ ìˆœì„œ ë°°ì—´ì—ë„ ì¶”ê°€ (ì—†ëŠ” ê²½ìš°ì—ë§Œ)
      if (!selectedFidsOrder.includes(fileId)) {
        selectedFidsOrder.push(fileId);
      }
    }
    
    const row = body.querySelector(`[data-file-id="${fileId}"]`);
    if (row) {
      const pickBtn = row.querySelector('button[class*="ì„ íƒ"]');
      if (pickBtn) {
        pickBtn.textContent = "ì„ íƒë¨";
        pickBtn.className = "px-3 py-1 rounded bg-blue-600 text-white text-sm";
      }
    }
  });
  
  // ì„ íƒ ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ (ì¹´í…Œê³ ë¦¬ ë¡œë“œ ì™„ë£Œ í›„)
  setTimeout(() => {
    updateSelectedList();
    // ê²€ìƒ‰ í•„í„° ë‹¤ì‹œ ì ìš©
    if (typeof searchCourses === 'function') {
      searchCourses();
    }
  }, 100);
}

async function updateCategoryCount(cat, codes, meta) {
  // í•„í„° ì ìš© í›„ì˜ ê³¼ëª© ìˆ˜ ê³„ì‚°
  const evalVal = document.getElementById("eval_choice")?.value || "ì „ì²´";
  const assignVal = document.getElementById("assign_choice")?.value || "ì „ì²´";
  const quizVal = document.getElementById("quiz_choice")?.value || "ì „ì²´";
  const creditVal = document.getElementById("credit_choice")?.value || "ì „ì²´";
  const webVal = document.getElementById("web_choice")?.value || "ì „ì²´";
  const sortVal = document.getElementById("sort_choice")?.value || "ê¸°ë³¸ìˆœ";

  if (codes.length === 0) {
    meta.textContent = "0ê³¼ëª©";
            return;
          }

  const form = new FormData();
  form.append("course_ids", codes.join(","));
  form.append("eval_choice", evalVal);
  form.append("assign_choice", assignVal);
  form.append("quiz_choice", quizVal);
  form.append("credit_choice", creditVal);
  if (STEP === 5) {
    form.append("web_choice", webVal);
  }
  form.append("sort_choice", sortVal);

  try {
    const res = await fetch("/recommend/sections", {method: "POST", body: form});
    const data = await res.json();
    const sections = Array.isArray(data.sections) ? data.sections : [];
    meta.textContent = `${sections.length}ê³¼ëª©`;
  } catch (error) {
    meta.textContent = `${codes.length}ê³¼ëª©`;
  }
}

function renderCoreCategories() {
  const cont = document.getElementById("sections_container");
  if (!cont) return;
  const map = BOOTSTRAP.coreMap || {};
  cont.innerHTML = "";

  const cats = ['1','2','3','4','5','6','ì°½ì˜','SW.AI'];
  cats.forEach(cat => {
    const codes = (map[String(cat)] || map[cat] || []).filter(Boolean);
    const card = document.createElement("div");
    card.className = "border rounded-xl";

    const header = document.createElement("div");
    header.className = "flex items-center justify-between p-3 bg-gray-50 rounded-t-xl";
    const title = document.createElement("div");
    title.className = "font-semibold";
    const label = (['1','2','3','4','5','6'].includes(cat)) ? `í•µì‹¬êµì–‘${cat}` : cat;
    title.textContent = label;
    const toggle = document.createElement("button");
    toggle.id = `core-toggle-${cat}`;
    toggle.className = "text-sm px-2 py-1 rounded border";
    toggle.textContent = "â–½";

    header.appendChild(title);
    const meta = document.createElement("div");
    meta.className = "text-xs text-gray-500 mr-2";
    meta.id = `core-meta-${cat}`;
    meta.textContent = `${codes.length}ê³¼ëª©`;
    // í•„í„° ì ìš© í›„ì˜ ê³¼ëª© ìˆ˜ë¡œ ì—…ë°ì´íŠ¸
    updateCategoryCount(cat, codes, meta);
    header.appendChild(meta);
    header.appendChild(toggle);

    const body = document.createElement("div");
    body.id = `core-body-${cat}`;
    body.className = "p-3 hidden";

    toggle.addEventListener("click", (e)=>{
      e.preventDefault();
      const isHidden = body.classList.contains("hidden");
      if (isHidden) {
        body.classList.remove("hidden");
        toggle.textContent = "â–³";
        loadCoreCategory(cat);
      } else {
        body.classList.add("hidden");
        toggle.textContent = "â–½";
      }
    });

    card.appendChild(header);
    card.appendChild(body);
    cont.appendChild(card);
  });
}

// ê³¼ëª© ê²€ìƒ‰ ê¸°ëŠ¥
function searchCourses() {
  const searchInput = document.getElementById("course_search");
  if (!searchInput) return;
  
  const searchTerm = searchInput.value.toLowerCase().trim();
  let visibleCount = 0;
  let totalCount = 0;
  
  if (STEP === 5) {
    // Step 5: í•µì‹¬êµì–‘ - ëª¨ë“  ì¹´í…Œê³ ë¦¬ì˜ ê³¼ëª© ê²€ìƒ‰
    const cats = ['1','2','3','4','5','6','ì°½ì˜','SW.AI'];
    cats.forEach(cat => {
      const body = document.getElementById(`core-body-${cat}`);
      if (body) {
        const rows = body.querySelectorAll('[data-course-id]');
        rows.forEach(row => {
          totalCount++;
          const courseId = (row.dataset.courseId || '').toLowerCase();
          const courseName = (row.dataset.courseName || '').toLowerCase();
          const prof = (row.dataset.prof || '').toLowerCase();
          
          if (searchTerm === '' || 
              courseId.includes(searchTerm) || 
              courseName.includes(searchTerm) || 
              prof.includes(searchTerm)) {
            row.style.display = '';
            visibleCount++;
          } else {
            row.style.display = 'none';
          }
        });
      }
    });
  } else {
    // Step 2, 3, 4, 6: ì¼ë°˜ ê³¼ëª© ëª©ë¡ ê²€ìƒ‰
    const container = document.getElementById('sections_container');
    if (container) {
      const rows = container.querySelectorAll('[data-course-id]');
      rows.forEach(row => {
        totalCount++;
        const courseId = (row.dataset.courseId || '').toLowerCase();
        const courseName = (row.dataset.courseName || '').toLowerCase();
        const prof = (row.dataset.prof || '').toLowerCase();
        
        if (searchTerm === '' || 
            courseId.includes(searchTerm) || 
            courseName.includes(searchTerm) || 
            prof.includes(searchTerm)) {
          row.style.display = '';
          visibleCount++;
        } else {
          row.style.display = 'none';
        }
      });
    }
  }
  
  // ê²€ìƒ‰ ê²°ê³¼ ê°œìˆ˜ í‘œì‹œ
  const resultCount = document.getElementById('search_result_count');
  if (resultCount) {
    if (searchTerm === '') {
      resultCount.textContent = `ì „ì²´ ${totalCount}ê°œ ê³¼ëª©`;
    } else {
      resultCount.textContent = `${visibleCount}ê°œ ê³¼ëª© ì°¾ìŒ (ì „ì²´ ${totalCount}ê°œ ì¤‘)`;
    }
  }
}

// ê²€ìƒ‰ ì…ë ¥ì°½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
if ([2,3,4,5,6].includes(STEP)) {
  const searchInput = document.getElementById("course_search");
  const clearBtn = document.getElementById("clear_search");
  
  if (searchInput) {
    searchInput.addEventListener("input", searchCourses);
    // ì—”í„°í‚¤ ë°©ì§€ (í¼ ì œì¶œ ë°©ì§€)
    searchInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
      }
    });
    // ì´ˆê¸° ê²€ìƒ‰ ê²°ê³¼ ê°œìˆ˜ í‘œì‹œ
    setTimeout(() => {
      searchCourses();
    }, 500);
  }
  
  // ê²€ìƒ‰ ì´ˆê¸°í™” ë²„íŠ¼
  if (clearBtn && searchInput) {
    clearBtn.addEventListener("click", (e) => {
      e.preventDefault();
      searchInput.value = '';
      searchCourses();
      searchInput.focus();
    });
  }
}

// ì„ íƒ ì´ˆê¸°í™”: í˜„ì¬ ìŠ¤í…ì˜ ì„ íƒë§Œ ì´ˆê¸°í™”
document.getElementById("reset_btn")?.addEventListener("click", async (e)=>{
  e.preventDefault();
  selectedFids.clear();
  selectedFidsOrder.length = 0; // ì„ íƒ ìˆœì„œ ë°°ì—´ë„ ì´ˆê¸°í™”
  updateHiddenInputs();
  
  // ì„œë²„ì— ì„ íƒ ì´ˆê¸°í™” ë°˜ì˜ (ë¹ˆ ë¬¸ìì—´ë¡œ ì „ì†¡)
  const form = new FormData();
  form.append("step", STEP);
  form.append("semester", BOOTSTRAP.semester);
  form.append("action", "save"); // ì„ íƒ ì´ˆê¸°í™”ë¥¼ ì €ì¥ ì•¡ì…˜ìœ¼ë¡œ ì²˜ë¦¬
  form.append("selected_fids", ""); // ë¹ˆ ë¬¸ìì—´ë¡œ ì „ì†¡í•˜ì—¬ ì„ íƒ ì´ˆê¸°í™”
  
  // í•„í„° ê°’ë„ í¬í•¨
  const evalVal = document.getElementById("eval_choice")?.value || "ì „ì²´";
  const assignVal = document.getElementById("assign_choice")?.value || "ì „ì²´";
  const quizVal = document.getElementById("quiz_choice")?.value || "ì „ì²´";
  const creditVal = document.getElementById("credit_choice")?.value || "ì „ì²´";
  const sortVal = document.getElementById("sort_choice")?.value || "ê¸°ë³¸ìˆœ";
  form.append("eval_choice", evalVal);
  form.append("assign_choice", assignVal);
  form.append("quiz_choice", quizVal);
  form.append("credit_choice", creditVal);
  form.append("sort_choice", sortVal);
  
  // Step 5ì¸ ê²½ìš° í•µì‹¬êµì–‘ í•™ì ë„ í¬í•¨
  if (STEP === 5) {
    const coreCreditsInput = document.querySelector('#core-credits-form input[name="core_credits"]');
    if (coreCreditsInput) {
      form.append("core_credits", coreCreditsInput.value || "");
    }
  }
  
  try {
    const res = await fetch("/recommend/step", {method: "POST", body: form});
    if (res.ok) {
      // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ì„œë²„ ìƒíƒœ ë°˜ì˜
      window.location.href = `/recommend?step=${STEP}&semester=${BOOTSTRAP.semester}`;
    }
  } catch (error) {
    console.error("ì„ íƒ ì´ˆê¸°í™” ì˜¤ë¥˜:", error);
    // ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ UIëŠ” ì—…ë°ì´íŠ¸
    updateSelectedList();
    if ([2,3,4,6].includes(STEP)) {
      loadSections();
    } else if (STEP === 5) {
      const cats = ['1','2','3','4','5','6','ì°½ì˜','SW.AI'];
      cats.forEach(cat => {
        const body = document.getElementById(`core-body-${cat}`);
        if (body && !body.classList.contains("hidden")) {
          loadCoreCategory(cat);
        }
      });
    }
  }
});

// ì„ íƒí•œ ê³¼ëª© ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
async function updateSelectedList() {
  const stepNamesMap = {2: "ì „ê³µí•„ìˆ˜", 3: "ì „ê³µì„ íƒ", 4: "ê¸°ì´ˆ/ì¤‘ì  êµì–‘", 5: "í•µì‹¬êµì–‘", 6: "ì¼ë°˜êµì–‘"};
  const stepName = stepNamesMap[STEP];
  if (!stepName) return;
  
  // ì„ íƒí•œ ê³¼ëª© ì •ë³´ë¥¼ ì €ì¥í•  Map (file_idë¥¼ í‚¤ë¡œ ì‚¬ìš©)
  const courseInfoMap = new Map();
  
  // 1. ìš°ì„  ì„œë²„ ë°ì´í„°ì—ì„œ ì„ íƒëœ í•­ëª© ì •ë³´ ê°€ì ¸ì˜¤ê¸° (í•„í„°ì™€ ê´€ê³„ì—†ì´ ëª¨ë“  ì„ íƒëœ í•­ëª©)
  const serverSelected = BOOTSTRAP.selectedCoursesByStep?.[stepName] || [];
  serverSelected.forEach(course => {
    const fileId = course.file_id;
    if (selectedFids.has(fileId)) {
      courseInfoMap.set(fileId, {
        course_id: course.course_id || '',
        course_name: course.course_name || '',
        prof: course.prof || '',
        credit: course.credit || ''
      });
    }
  });
  
  // 2. ì„œë²„ ë°ì´í„°ì— ì—†ëŠ” í•­ëª©ì€ DOMì—ì„œ ì°¾ê¸° (í˜„ì¬ í•„í„°ì— ë§ëŠ” í•­ëª©ë§Œ DOMì— ìˆì„ ìˆ˜ ìˆìŒ)
  const missingFromServer = Array.from(selectedFids).filter(fid => !courseInfoMap.has(fid));
  if (missingFromServer.length > 0) {
    let selector = '';
    if (STEP === 5) {
      // Step 5: ëª¨ë“  core-body ë‚´ë¶€ì˜ ìš”ì†Œ ì°¾ê¸° (ìˆ¨ê²¨ì§„ ì¹´í…Œê³ ë¦¬ë„ í¬í•¨)
      selector = '[id^="core-body-"] [data-file-id]';
    } else {
      // Step 2, 3, 4, 6: sections_container ë‚´ë¶€ì˜ ìš”ì†Œ ì°¾ê¸°
      selector = '#sections_container [data-file-id]';
    }
    
    document.querySelectorAll(selector).forEach(row => {
      const fileId = row.dataset.fileId;
      if (selectedFids.has(fileId) && !courseInfoMap.has(fileId)) {
        courseInfoMap.set(fileId, {
          course_id: row.dataset.courseId || '',
          course_name: row.dataset.courseName || '',
          prof: row.dataset.prof || '',
          credit: row.dataset.credit || ''
        });
      }
    });
  }
  
  // 3. ì„œë²„ ë°ì´í„°ì™€ DOMì—ì„œ ëª¨ë‘ ì°¾ì§€ ëª»í•œ í•­ëª©ì€ file_idë¡œ ì§ì ‘ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (AJAX)
  const missingFileIds = Array.from(selectedFids).filter(fid => !courseInfoMap.has(fid));
  if (missingFileIds.length > 0) {
    // ê° file_idì—ì„œ course_id ì¶”ì¶œ (ì˜ˆ: "AIE1002.001.json" -> "AIE1002.001")
    // file_id í˜•ì‹: "AIE1002.001.json" ë˜ëŠ” "AIE1002.001" ë“±
    const courseIds = new Set();
    missingFileIds.forEach(fileId => {
      // ".json" í™•ì¥ì ì œê±°
      const withoutExt = fileId.replace(/\.json$/, '');
      const parts = withoutExt.split('.');
      if (parts.length >= 2) {
        // "AIE1002.001" í˜•ì‹ìœ¼ë¡œ course_id ìƒì„±
        const courseId = `${parts[0]}.${parts[1]}`;
        courseIds.add(courseId);
      } else if (parts.length === 1) {
        // "AIE1002" í˜•ì‹ë§Œ ìˆëŠ” ê²½ìš°
        courseIds.add(parts[0]);
      }
    });
    
    if (courseIds.size > 0) {
      try {
        const form = new FormData();
        form.append("course_ids", Array.from(courseIds).join(","));
        form.append("eval_choice", "ì „ì²´");
        form.append("assign_choice", "ì „ì²´");
        form.append("quiz_choice", "ì „ì²´");
        form.append("credit_choice", "ì „ì²´");
        form.append("web_choice", "ì „ì²´");
        form.append("sort_choice", "ê¸°ë³¸ìˆœ");
        
        const res = await fetch("/recommend/sections", {method: "POST", body: form});
        const data = await res.json();
        const sections = Array.isArray(data.sections) ? data.sections : [];
        
        sections.forEach(sec => {
          if (selectedFids.has(sec.file_id) && !courseInfoMap.has(sec.file_id)) {
            courseInfoMap.set(sec.file_id, {
              course_id: sec.course_id || '',
              course_name: sec.course_name || '',
              prof: sec.prof || '',
              credit: sec.credit || ''
            });
          }
        });
      } catch (error) {
        console.error("ì„ íƒëœ í•­ëª© ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:", error);
      }
    }
  }
  
  // 4. ì„ íƒí•œ ìˆœì„œëŒ€ë¡œ ì •ë ¬ëœ ë°°ì—´ ìƒì„± (selectedFidsOrder ìˆœì„œ ìœ ì§€)
  const selectedCourses = [];
  selectedFidsOrder.forEach(fileId => {
    if (selectedFids.has(fileId) && courseInfoMap.has(fileId)) {
      selectedCourses.push(courseInfoMap.get(fileId));
    }
  });
  
  // ì„ íƒí•œ ê³¼ëª© ë¦¬ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ ì°¾ê¸°
  const listContainer = document.getElementById('selected-courses-list');
  if (listContainer) {
    if (selectedFids.size === 0) {
      listContainer.style.display = 'none';
    } else {
      // í•­ìƒ í‘œì‹œ (í•„í„° ë³€ê²½ê³¼ ê´€ê³„ì—†ì´)
      listContainer.style.display = 'block';
      // ì„ íƒëœ í•­ëª© ìˆ˜ëŠ” selectedFids.sizeë¥¼ ê¸°ì¤€ìœ¼ë¡œ í‘œì‹œ
      const count = selectedFids.size;
      
      // Step 5ì—ì„œ í•µì‹¬êµì–‘ í•™ì  ê²€ì¦
      let warningMessage = '';
      if (STEP === 5 && BOOTSTRAP.coreCredits && BOOTSTRAP.coreCredits > 0) {
        const coreCreditsTarget = BOOTSTRAP.coreCredits;
        let totalCoreCredits = 0;
        selectedCourses.forEach(c => {
          const credit = parseInt(c.credit) || 0;
          totalCoreCredits += credit;
        });
        
        // ì„ íƒí•œ ê³¼ëª©ë“¤ì˜ í•™ì  ë¦¬ìŠ¤íŠ¸
        const selectedCredits = selectedCourses.map(c => parseInt(c.credit) || 0).filter(c => c > 0);
        
        if (selectedCredits.length > 0) {
          // ì„ íƒí•œ ê³¼ëª©ë“¤ì˜ ìµœëŒ€ í•™ì  í•©ê³„ (ëª¨ë“  ê³¼ëª©ì„ ì„ íƒí•œ ê²½ìš°)
          const maxPossibleCredits = selectedCredits.reduce((sum, credit) => sum + credit, 0);
          
          // ì„ íƒí•œ í•™ì ì´ ì„¤ì •í•œ í•™ì ë³´ë‹¤ ì ì€ ê²½ìš°
          if (totalCoreCredits < coreCreditsTarget) {
            warningMessage = `
              <div class="mt-3 p-3 bg-red-50 border border-red-200 rounded text-sm text-red-700">
                <strong>âš ï¸ ê²½ê³ :</strong> ì„¤ì •í•œ í•µì‹¬êµì–‘ í•™ì (${coreCreditsTarget}í•™ì )ë³´ë‹¤ ì ì€ í•™ì ì„ ì„ íƒí–ˆìŠµë‹ˆë‹¤. 
                ìµœì†Œ ${coreCreditsTarget}í•™ì  ì´ìƒì€ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤. (í˜„ì¬ ì„ íƒ: ${totalCoreCredits}í•™ì )
              </div>
            `;
          } else if (coreCreditsTarget > maxPossibleCredits) {
            // ì„¤ì •í•œ í•™ì ì´ ì„ íƒí•œ ê³¼ëª©ë“¤ì˜ ìµœëŒ€ í•©ê³„ë¥¼ ì´ˆê³¼í•˜ë©´ ê²½ê³ 
            warningMessage = `
              <div class="mt-3 p-3 bg-red-50 border border-red-200 rounded text-sm text-red-700">
                <strong>âš ï¸ ê²½ê³ :</strong> ì„ íƒí•œ í•µì‹¬êµì–‘ ê³¼ëª©ë“¤ì˜ ì´ í•™ì (${maxPossibleCredits}í•™ì )ìœ¼ë¡œëŠ” ì„¤ì •í•œ í•™ì (${coreCreditsTarget}í•™ì )ì„ ë‹¬ì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. 
                ë” ë§ì€ ê³¼ëª©ì„ ì„ íƒí•˜ê±°ë‚˜ í•™ì  ì„¤ì •ê°’ì„ ì¡°ì •í•´ì£¼ì„¸ìš”.
              </div>
            `;
          } else if (coreCreditsTarget <= maxPossibleCredits) {
            // ì„ íƒí•œ ê³¼ëª©ë“¤ì˜ ì¡°í•©ìœ¼ë¡œ ì„¤ì •í•œ í•™ì ì„ ë§Œë“¤ ìˆ˜ ìˆëŠ”ì§€ í™•ì¸ (ë¶€ë¶„ì§‘í•© í•© ë¬¸ì œ)
            // ë™ì  í”„ë¡œê·¸ë˜ë°ì„ ì‚¬ìš©í•˜ì—¬ ê°€ëŠ¥í•œ ì¡°í•© í™•ì¸
            function canMakeTarget(credits, target) {
              if (target === 0) return true;
              if (credits.length === 0 || target < 0) return false;
              
              // DP ë°°ì—´: dp[i] = ií•™ì ì„ ë§Œë“¤ ìˆ˜ ìˆëŠ”ì§€ ì—¬ë¶€
              const dp = new Array(target + 1).fill(false);
              dp[0] = true; // 0í•™ì ì€ í•­ìƒ ê°€ëŠ¥
              
              for (const credit of credits) {
                for (let i = target; i >= credit; i--) {
                  if (dp[i - credit]) {
                    dp[i] = true;
                  }
                }
              }
              
              return dp[target];
            }
            
            // ì„ íƒí•œ ê³¼ëª©ë“¤ì˜ ì¡°í•©ìœ¼ë¡œ ëª©í‘œ í•™ì ì„ ë§Œë“¤ ìˆ˜ ìˆëŠ”ì§€ í™•ì¸
            if (!canMakeTarget(selectedCredits, coreCreditsTarget)) {
              // ê°€ëŠ¥í•œ í•™ì  ì¡°í•© ëª©ë¡ ìƒì„± (ë™ì  í”„ë¡œê·¸ë˜ë° ì‚¬ìš©)
              const possibleCredits = new Set([0]);
              for (const credit of selectedCredits) {
                const newPossible = new Set(possibleCredits);
                for (const sum of possibleCredits) {
                  newPossible.add(sum + credit);
                }
                possibleCredits.clear();
                newPossible.forEach(s => possibleCredits.add(s));
              }
              const sortedPossible = Array.from(possibleCredits).filter(s => s > 0 && s <= maxPossibleCredits).sort((a, b) => a - b);
              const possibleList = sortedPossible.length > 0 ? sortedPossible.join(', ') : 'ì—†ìŒ';
              
              warningMessage = `
                <div class="mt-3 p-3 bg-red-50 border border-red-200 rounded text-sm text-red-700">
                  <strong>âš ï¸ ê²½ê³ :</strong> ì„ íƒí•œ í•µì‹¬êµì–‘ ê³¼ëª©ë“¤ì˜ ì¡°í•©ìœ¼ë¡œëŠ” ì„¤ì •í•œ í•™ì (${coreCreditsTarget}í•™ì )ì„ ë§Œë“¤ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. 
                  ì„ íƒí•œ ê³¼ëª©ë“¤ë¡œ ë§Œë“¤ ìˆ˜ ìˆëŠ” í•™ì  ì¡°í•©: ${possibleList}í•™ì 
                </div>
              `;
            }
          }
        }
      }
      
      const listHtml = `
        <div class="font-semibold text-sm mb-2">${stepName} ì„ íƒí•œ ê³¼ëª© (${count}ê°œ):</div>
        <div class="space-y-1">
          ${selectedCourses.length > 0 
            ? selectedCourses.map(c => `<div class="text-sm text-gray-700">${c.course_id} â€” ${c.course_name} (${c.prof}) â€” ${c.credit}í•™ì </div>`).join('')
            : selectedFids.size > 0
              ? `<div class="text-sm text-gray-500">ì„ íƒëœ í•­ëª©ì´ ìˆì§€ë§Œ ì„¸ë¶€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤... (${count}ê°œ ì„ íƒë¨)</div>`
              : ''}
        </div>
        ${warningMessage}
      `;
      listContainer.innerHTML = listHtml;
      
      // ì¼ë°˜êµì–‘ ìŠ¤í…ì—ì„œëŠ” í•„í„° ë³€ê²½ê³¼ ê´€ê³„ì—†ì´ í•­ìƒ í‘œì‹œ (ê°•ì œ)
      if (STEP === 6 && selectedFids.size > 0) {
        listContainer.style.display = 'block';
      }
    }
  }
}

// ì„ íƒ ë²„íŠ¼ í´ë¦­ ì‹œ ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
function attachListUpdateListeners() {
  document.querySelectorAll('#sections_container button').forEach(btn => {
    if (btn.textContent.includes('ì„ íƒ')) {
      btn.addEventListener('click', () => {
        setTimeout(updateSelectedList, 100);
      });
    }
  });
}

["eval_choice","assign_choice","quiz_choice","credit_choice","web_choice","sort_choice"].forEach(id=>{
  document.getElementById(id)?.addEventListener("change", ()=>{
    // í•„í„° ë³€ê²½ ì „ì— ì„ íƒ ìƒíƒœë¥¼ ì„œë²„ì— ì €ì¥ (í•„í„° ë³€ê²½ í›„ì—ë„ ì„ íƒ ìƒíƒœ ìœ ì§€)
    updateHiddenInputs();
    
    if (STEP === 5) {
      const cats = ['1','2','3','4','5','6','ì°½ì˜','SW.AI'];
      cats.forEach(cat => {
        const body = document.getElementById(`core-body-${cat}`);
        if (body && !body.classList.contains("hidden")) {
          loadCoreCategory(cat);
        }
        // í•„í„° ë³€ê²½ ì‹œ ê³¼ëª© ìˆ˜ ì—…ë°ì´íŠ¸
        const meta = document.getElementById(`core-meta-${cat}`);
        if (meta) {
          const map = BOOTSTRAP.coreMap || {};
          const codes = (map[String(cat)] || map[cat] || []).filter(Boolean);
          updateCategoryCount(cat, codes, meta);
        }
      });
    } else {
      loadSections();
    }
    
    // í•„í„° ë³€ê²½ í›„ì—ë„ ì„ íƒ ë¦¬ìŠ¤íŠ¸ëŠ” í•­ìƒ ìœ ì§€ (ì§€ì—° í˜¸ì¶œë¡œ DOM ë Œë”ë§ ì™„ë£Œ í›„ ì—…ë°ì´íŠ¸)
    // ì¼ë°˜êµì–‘ ìŠ¤í…(STEP === 6)ì—ì„œëŠ” í•„í„° ë³€ê²½ê³¼ ê´€ê³„ì—†ì´ í•­ìƒ ì„ íƒ ë¦¬ìŠ¤íŠ¸ í‘œì‹œ
    setTimeout(() => {
      updateSelectedList();
      // ì¼ë°˜êµì–‘ ìŠ¤í…ì—ì„œëŠ” ì„ íƒ ë¦¬ìŠ¤íŠ¸ê°€ í•­ìƒ ë³´ì´ë„ë¡ ê°•ì œ í‘œì‹œ
      if (STEP === 6) {
        const listContainer = document.getElementById('selected-courses-list');
        if (listContainer && selectedFids.size > 0) {
          listContainer.style.display = 'block';
        }
      }
    }, 200);
  });
});

// Form ì œì¶œ ì „ì— í•­ìƒ hidden input ì—…ë°ì´íŠ¸
const stepForm = document.getElementById("step-navigation-form");
if (stepForm) {
  stepForm.addEventListener("submit", (e) => {
    // ì œì¶œ ì „ì— ìµœì‹  ì„ íƒ ë‚´ì—­ ì—…ë°ì´íŠ¸
    updateHiddenInputs();
    // form ì œì¶œì€ ê³„ì† ì§„í–‰
  });
}

// í•µì‹¬êµì–‘ í•™ì  ì„¤ì • í¼ ì œì¶œ ì „ì— hidden input ì—…ë°ì´íŠ¸
const coreCreditsForm = document.getElementById("core-credits-form");
if (coreCreditsForm) {
  coreCreditsForm.addEventListener("submit", (e) => {
    // ì œì¶œ ì „ì— ìµœì‹  ì„ íƒ ë‚´ì—­ ë° í•„í„° ê°’ ì—…ë°ì´íŠ¸
    updateCoreCreditsForm();
    // form ì œì¶œì€ ê³„ì† ì§„í–‰
  });
  
  // í•µì‹¬êµì–‘ í•™ì  ì…ë ¥ê°’ì´ ë³€ê²½ë  ë•Œë§ˆë‹¤ ê²½ê³  ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
  const coreCreditsInput = coreCreditsForm.querySelector('input[name="core_credits"]');
  if (coreCreditsInput) {
    coreCreditsInput.addEventListener("input", () => {
      const value = parseInt(coreCreditsInput.value) || null;
      BOOTSTRAP.coreCredits = value;
      if (STEP === 5) {
        updateSelectedList(); // ê²½ê³  ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
      }
    });
    
    // í•µì‹¬êµì–‘ í•™ì  ì…ë ¥ê°’ì´ blurë  ë•Œë„ ê²½ê³  ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
    coreCreditsInput.addEventListener("blur", () => {
      const value = parseInt(coreCreditsInput.value) || null;
      BOOTSTRAP.coreCredits = value;
      if (STEP === 5) {
        updateSelectedList(); // ê²½ê³  ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
      }
    });
  }
}

updateHiddenInputs();

// í•™ê¸° ë³€ê²½ ì‹œ í˜„ì¬ ì„ íƒ ë‚´ì—­ì„ ì„œë²„ì— ì €ì¥í•œ í›„ í•™ê¸° ë³€ê²½
// (ê¸°ì¡´ ì„ íƒ ë‚´ì—­ì€ ìœ ì§€ë˜ê³ , ìƒˆë¡œìš´ í•™ê¸°ì˜ ì„ íƒ ë‚´ì—­ì´ ì¶”ê°€ë¨)
const semesterForm = document.getElementById("semester-form");
const semesterSelect = document.getElementById("semester-select");
if (semesterForm && semesterSelect && [2,3,4].includes(STEP)) {
  semesterSelect.addEventListener("change", async (e) => {
    e.preventDefault();
    const newSemester = semesterSelect.value;
    
    // í˜„ì¬ ì„ íƒ ë‚´ì—­ì„ ì„œë²„ì— ì €ì¥ (ê¸°ì¡´ ì„ íƒ ë‚´ì—­ê³¼ ë³‘í•©)
    updateHiddenInputs();
    const selectedStr = Array.from(selectedFids).join(",");
    const evalVal = document.getElementById("eval_choice")?.value || "ì „ì²´";
    const assignVal = document.getElementById("assign_choice")?.value || "ì „ì²´";
    const quizVal = document.getElementById("quiz_choice")?.value || "ì „ì²´";
    const creditVal = document.getElementById("credit_choice")?.value || "ì „ì²´";
    const sortVal = document.getElementById("sort_choice")?.value || "ê¸°ë³¸ìˆœ";
    
    const form = new FormData();
    form.append("step", STEP);
    form.append("semester", BOOTSTRAP.semester); // í˜„ì¬ í•™ê¸°
    form.append("action", "save"); // ì €ì¥ ì•¡ì…˜
    // í˜„ì¬ ì„ íƒ ë‚´ì—­ ì „ë‹¬ (ì„œë²„ì—ì„œ ê¸°ì¡´ ì„ íƒ ë‚´ì—­ê³¼ ë³‘í•©)
    form.append("selected_fids", selectedStr);
    form.append("eval_choice", evalVal);
    form.append("assign_choice", assignVal);
    form.append("quiz_choice", quizVal);
    form.append("credit_choice", creditVal);
    form.append("sort_choice", sortVal);
    
    try {
      // ì„ íƒ ë‚´ì—­ ì €ì¥ (ì„œë²„ì—ì„œ ê¸°ì¡´ ì„ íƒ ë‚´ì—­ê³¼ ë³‘í•©)
      await fetch("/recommend/step", {method: "POST", body: form});
      // ì €ì¥ í›„ í•™ê¸° ë³€ê²½ (ì„œë²„ì—ì„œ ê¸°ì¡´ ì„ íƒ ë‚´ì—­ì„ ìœ ì§€)
      window.location.href = `/recommend?step=${STEP}&semester=${newSemester}`;
    } catch (error) {
      console.error("í•™ê¸° ë³€ê²½ ì˜¤ë¥˜:", error);
      // ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ í•™ê¸° ë³€ê²½
      window.location.href = `/recommend?step=${STEP}&semester=${newSemester}`;
    }
  });
}

if ([2,3,4,6].includes(STEP)) {
  loadSections();
} else if (STEP === 5) {
  renderCoreCategories();
  // Step 5 ì´ˆê¸° ë¡œë“œ ì‹œ ì„ íƒ ë¦¬ìŠ¤íŠ¸ ì¦‰ì‹œ í‘œì‹œ (ì„œë²„ ë°ì´í„° ì‚¬ìš©)
  updateSelectedList();
  
  // ì„ íƒëœ í•­ëª©ì´ ìˆìœ¼ë©´ í•´ë‹¹ ì¹´í…Œê³ ë¦¬ ìë™ìœ¼ë¡œ ì—´ê¸° (ì„ íƒ ì‚¬í•­)
  if (selectedFids.size > 0) {
    setTimeout(() => {
      const cats = ['1','2','3','4','5','6','ì°½ì˜','SW.AI'];
      cats.forEach(cat => {
        const body = document.getElementById(`core-body-${cat}`);
        const toggle = document.getElementById(`core-toggle-${cat}`);
        if (body && toggle && body.classList.contains("hidden")) {
          // ì¹´í…Œê³ ë¦¬ ì—´ê¸° (ì‚¬ìš©ìê°€ í™•ì¸í•  ìˆ˜ ìˆë„ë¡)
          body.classList.remove("hidden");
          toggle.textContent = "â–³";
          loadCoreCategory(cat);
        }
      });
    }, 300);
  }
}

// Step 7 í† ê¸€ í•¨ìˆ˜ë“¤
function toggleSelectedSummary() {
  const content = document.getElementById('selected-summary-content');
  const toggle = document.getElementById('selected-summary-toggle');
  if (content && toggle) {
    const isHidden = content.classList.contains('hidden');
    content.classList.toggle('hidden');
    // í† ê¸€ ì•„ì´ì½˜ íšŒì „ (â–¶ê°€ 90ë„ íšŒì „í•˜ì—¬ â–¼ì²˜ëŸ¼ ë³´ì´ê²Œ)
    if (isHidden) {
      toggle.style.transform = 'rotate(90deg)';
    } else {
      toggle.style.transform = 'rotate(0deg)';
    }
  }
}

function toggleSchedule(index) {
  const content = document.getElementById(`schedule-content-${index}`);
  const toggle = document.getElementById(`schedule-toggle-${index}`);
  if (content && toggle) {
    content.classList.toggle('hidden');
    toggle.style.transform = content.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(90deg)';
    
    // ì‹œê°„í‘œê°€ ì—´ë¦´ ë•Œ ìŠ¬ë¡¯ ìœ„ì¹˜ ì¬ê³„ì‚°
    if (!content.classList.contains('hidden')) {
      setTimeout(() => {
        positionScheduleSlots(content);
      }, 50);
    }
  }
}

function toggleAISchedule(index) {
  const content = document.getElementById(`ai-schedule-content-${index}`);
  const toggle = document.getElementById(`ai-schedule-toggle-${index}`);
  if (content && toggle) {
    content.classList.toggle('hidden');
    toggle.style.transform = content.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(90deg)';
    
    // AI ì‹œê°„í‘œê°€ ì—´ë¦´ ë•Œ ìŠ¬ë¡¯ ìœ„ì¹˜ ì¬ê³„ì‚°
    if (!content.classList.contains('hidden')) {
      setTimeout(() => {
        positionAIScheduleSlots(content);
      }, 50);
    }
  }
}

function refreshAISchedule() {
  // í˜„ì¬ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ (AI ì¶”ì²œì´ ë‹¤ì‹œ ìƒì„±ë¨)
  if (confirm('AI ì¶”ì²œ ì‹œê°„í‘œë¥¼ ë‹¤ì‹œ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (í˜ì´ì§€ê°€ ìƒˆë¡œê³ ì¹¨ë©ë‹ˆë‹¤)')) {
    window.location.reload();
  }
}

async function generateAISchedule() {
  const feedbackTextarea = document.getElementById('ai-feedback-input');
  const feedback = feedbackTextarea ? feedbackTextarea.value.trim() : '';
  
  // ë¡œë”© í‘œì‹œ
  const button = event.target;
  const originalText = button.textContent;
  button.disabled = true;
  button.textContent = 'â³ AIê°€ ì‹œê°„í‘œë¥¼ ìƒì„±í•˜ëŠ” ì¤‘...';
  
  try {
    const response = await fetch('/api/ai-recommend/refresh', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        feedback: feedback || null
      })
    });
    
    const data = await response.json();
    console.log('AI ì¶”ì²œ ì‘ë‹µ:', data);
    
    if (data.success && data.schedules && data.schedules.length > 0) {
      // ì„±ê³µ: AI ì¶”ì²œ ìš”ì²­ ì„¹ì…˜ ìˆ¨ê¸°ê³  ê²°ê³¼ í‘œì‹œ
      const requestSection = document.querySelector('[id^="ai-feedback-input"]')?.closest('.mb-6');
      if (requestSection) {
        requestSection.style.display = 'none';
      }
      
      // AI ì¶”ì²œ ì‹œê°„í‘œ ë™ì  ìƒì„± ë° í‘œì‹œ
      console.log('AI ì‹œê°„í‘œ ë Œë”ë§ ì‹œì‘:', data.schedules);
      renderAISchedules(data.schedules);
      console.log('AI ì‹œê°„í‘œ ë Œë”ë§ ì™„ë£Œ');
      
      button.disabled = false;
      button.textContent = originalText;
    } else {
      console.error('AI ì¶”ì²œ ì‹¤íŒ¨:', data);
      alert('ì‹œê°„í‘œ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      button.disabled = false;
      button.textContent = originalText;
    }
  } catch (error) {
    console.error('AI ì¶”ì²œ ìƒì„± ì˜¤ë¥˜:', error);
    alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    button.disabled = false;
    button.textContent = originalText;
  }
}

async function refreshAIScheduleWithFeedback(index) {
  const feedbackTextarea = document.getElementById(`ai-feedback-${index}`);
  const feedback = feedbackTextarea ? feedbackTextarea.value.trim() : '';
  
  // ë¡œë”© í‘œì‹œ
  const button = event.target;
  const originalText = button.textContent;
  button.disabled = true;
  button.textContent = 'â³ AIê°€ ì‹œê°„í‘œë¥¼ ìƒì„±í•˜ëŠ” ì¤‘...';
  
  try {
    const response = await fetch('/api/ai-recommend/refresh', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        feedback: feedback || null
      })
    });
    
    const data = await response.json();
    console.log('AI ì¶”ì²œ ìƒˆë¡œê³ ì¹¨ ì‘ë‹µ:', data);
    
    if (data.success && data.schedules && data.schedules.length > 0) {
      // ì„±ê³µ: ê¸°ì¡´ ì‹œê°„í‘œë¥¼ ìƒˆ ì‹œê°„í‘œë¡œ êµì²´
      console.log('AI ì‹œê°„í‘œ ìƒˆë¡œê³ ì¹¨ ë Œë”ë§ ì‹œì‘:', data.schedules);
      renderAISchedules(data.schedules);
      console.log('AI ì‹œê°„í‘œ ìƒˆë¡œê³ ì¹¨ ë Œë”ë§ ì™„ë£Œ');
      
      button.disabled = false;
      button.textContent = originalText;
    } else {
      console.error('AI ì¶”ì²œ ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨:', data);
      alert('ì‹œê°„í‘œ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      button.disabled = false;
      button.textContent = originalText;
    }
  } catch (error) {
    console.error('AI ì¶”ì²œ ìƒˆë¡œê³ ì¹¨ ì˜¤ë¥˜:', error);
    alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    button.disabled = false;
    button.textContent = originalText;
  }
}

function renderAISchedules(schedules) {
  console.log('renderAISchedules í˜¸ì¶œë¨, schedules:', schedules);
  // AI ì¶”ì²œ ì‹œê°„í‘œ ì»¨í…Œì´ë„ˆ ì°¾ê¸° ë˜ëŠ” ìƒì„±
  let container = document.getElementById('ai-schedules-container');
  if (!container) {
    // ì»¨í…Œì´ë„ˆê°€ ì—†ìœ¼ë©´ ìƒì„±
    const requestSection = document.querySelector('[id^="ai-feedback-input"]')?.closest('.mb-6');
    if (requestSection) {
      container = document.createElement('div');
      container.id = 'ai-schedules-container';
      container.className = 'mb-6 border-2 border-purple-400 rounded-xl overflow-hidden bg-purple-50 shadow-lg';
      container.innerHTML = `
        <div class="p-3 bg-gradient-to-r from-purple-500 to-purple-600 text-white">
          <div class="flex items-center gap-2">
            <span class="text-lg font-bold">ğŸ¤– AI ì¶”ì²œ</span>
          </div>
        </div>
      `;
      requestSection.insertAdjacentElement('afterend', container);
      console.log('AI ì¶”ì²œ ì»¨í…Œì´ë„ˆ ìƒì„±ë¨');
    } else {
      console.error('AI ì¶”ì²œ ì„¹ì…˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
  }
  
  // ê¸°ì¡´ ë‚´ìš© ì œê±° (í—¤ë” ì œì™¸)
  const header = container.querySelector('.bg-gradient-to-r');
  const headerHTML = header ? header.outerHTML : '';
  container.innerHTML = headerHTML;
  
  // ê° ì‹œê°„í‘œ ë Œë”ë§
  schedules.forEach((schedule, index) => {
    console.log(`ì‹œê°„í‘œ ${index} ë Œë”ë§ ì¤‘:`, schedule);
    const scheduleDiv = createAIScheduleHTML(schedule, index);
    container.appendChild(scheduleDiv);
  });
  
  console.log('ì‹œê°„í‘œ ë Œë”ë§ ì™„ë£Œ, ì»¨í…Œì´ë„ˆ:', container);
  
  // ìŠ¬ë¡¯ ìœ„ì¹˜ ê³„ì‚°
  setTimeout(() => {
    const layers = container.querySelectorAll('.ai-schedule-layer');
    console.log('ìŠ¬ë¡¯ ìœ„ì¹˜ ê³„ì‚°, layers:', layers.length);
    layers.forEach(layer => {
      positionAIScheduleSlots(layer);
    });
  }, 100);
}

function createAIScheduleHTML(schedule, index) {
  const creditsByCat = schedule.credits_by_category || {};
  const sections = schedule.sections || [];
  const aiSuggestion = schedule.ai_suggestion || '';
  
  const div = document.createElement('div');
  div.className = 'border-t-2 border-purple-300';
  div.innerHTML = `
    <button onclick="toggleAISchedule(${index})" class="w-full p-3 bg-purple-100 hover:bg-purple-200 flex items-center text-left">
      <div class="text-purple-600 transition-transform mr-3 flex-shrink-0" id="ai-schedule-toggle-${index}" style="transform: rotate(90deg);">â–¼</div>
      <div class="flex items-center gap-4 flex-1">
        <div class="font-semibold text-sm text-purple-900">AI ì¶”ì²œ ì‹œê°„í‘œ</div>
        <div class="text-xs text-purple-700">
          ì´ í•™ì : <b>${schedule.total_credits}</b>
          | ì „ê³µí•„ìˆ˜: ${creditsByCat['ì „ê³µí•„ìˆ˜'] || 0}
          | ì „ê³µì„ íƒ: ${creditsByCat['ì „ê³µì„ íƒ'] || 0}
          | ê¸°ì´ˆ/ì¤‘ì  êµì–‘: ${creditsByCat['ê¸°ì´ˆ/ì¤‘ì  êµì–‘'] || 0}
          | í•µì‹¬êµì–‘: ${creditsByCat['í•µì‹¬êµì–‘'] || 0}
          | ì¼ë°˜êµì–‘: ${creditsByCat['ì¼ë°˜êµì–‘'] || 0}
        </div>
      </div>
    </button>
    
    <!-- í”¼ë“œë°± ì…ë ¥ ì„¹ì…˜ (í•­ìƒ í‘œì‹œ) -->
    <div class="p-3 bg-purple-50 border-t border-purple-200">
      <div class="mb-2">
        <textarea 
          id="ai-feedback-${index}" 
          class="w-full p-2 text-sm border border-purple-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 resize-none"
          rows="3"
          placeholder="ë¬´ì—‡ì´ë“  ë¶€íƒí•˜ì„¸ìš”"></textarea>
      </div>
      <button 
        onclick="refreshAIScheduleWithFeedback(${index})" 
        class="w-full px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg text-sm font-medium transition-colors">
        ğŸ”„ í”¼ë“œë°± ë°˜ì˜í•˜ì—¬ ìƒˆë¡œ ìƒì„±
      </button>
    </div>
    
    <!-- AI ì‹œê°„í‘œ ë‚´ìš© (í† ê¸€) -->
    <div id="ai-schedule-content-${index}" class="p-3 bg-white">
      ${aiSuggestion ? `
        <div class="mb-4 p-3 bg-blue-50 border-l-4 border-blue-400 rounded-lg">
          <div class="flex items-start">
            <div class="flex-shrink-0">
              <svg class="h-5 w-5 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
              </svg>
            </div>
            <div class="ml-2 flex-1">
              <h4 class="text-sm font-semibold text-blue-900 mb-1">ğŸ’¡ AI ì¶”ì²œ ì œì•ˆ</h4>
              <div class="text-sm text-blue-800 whitespace-pre-line">${aiSuggestion}</div>
            </div>
          </div>
        </div>
      ` : ''}
      
      <div class="grid grid-cols-6 text-center text-xs font-semibold bg-purple-100 border-b rounded-t">
        <div class="py-2">ì‹œê°„</div>
        <div class="py-2">ì›”</div>
        <div class="py-2">í™”</div>
        <div class="py-2">ìˆ˜</div>
        <div class="py-2">ëª©</div>
        <div class="py-2">ê¸ˆ</div>
      </div>
      <div class="relative">
        <div class="grid grid-cols-6" style="grid-template-rows: repeat(13, 40px); max-height: 520px; overflow-y: auto;">
          ${Array.from({length: 13}, (_, i) => {
            const hour = 9 + i;
            return `
              <div class="text-xs text-right pr-2 border-r py-1.5">${String(hour).padStart(2, '0')}:00</div>
              ${Array.from({length: 5}, () => '<div class="border-b border-r"></div>').join('')}
            `;
          }).join('')}
        </div>
        <div class="absolute inset-0 ai-schedule-layer" style="max-height: 520px; overflow-y: auto;">
          ${renderScheduleSlots(sections)}
        </div>
      </div>
      <div class="mt-2 text-xs">
        <div class="font-semibold">ì›¹ê°•ì˜</div>
        <ul class="list-disc pl-5">
          ${sections.filter(s => s.is_web).map(s => 
            `<li>${s.course_name} (${s.course_id}) â€” ${s.prof || ''} â€” ${s.credit}í•™ì </li>`
          ).join('')}
        </ul>
      </div>
    </div>
  `;
  return div;
}

function renderScheduleSlots(sections) {
  // sections ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìŠ¬ë¡¯ ë Œë”ë§
  // meetings í˜•ì‹: [[day, start_slot, end_slot], ...]
  let html = '';
  sections.forEach(section => {
    if (section.meetings && Array.isArray(section.meetings)) {
      section.meetings.forEach(meeting => {
        const [day, sslot, eslot] = meeting;
        html += `
          <div class="slot absolute rounded text-white p-2 overflow-hidden"
               data-day="${day}"
               data-sslot="${sslot}"
               data-eslot="${eslot}"
               style="box-sizing: border-box;">
            <div class="font-semibold text-xs leading-tight mb-1">${section.course_name || ''}</div>
            <div class="opacity-90 text-xs leading-tight">${section.course_id || ''}</div>
          </div>
        `;
      });
    }
  });
  return html;
}

function positionScheduleSlots(container) {
  // containerê°€ .schedule-layerì¸ ê²½ìš°ì™€ ê·¸ ë¶€ëª¨ì¸ ê²½ìš° ëª¨ë‘ ì²˜ë¦¬
  const layer = container.classList.contains('schedule-layer') 
    ? container 
    : container.querySelector('.schedule-layer');
  if (!layer) return;
  
  const slots = layer.querySelectorAll('.slot');
  slots.forEach(el => {
    const day = Number(el.dataset.day || 0);
    const sslot = Number(el.dataset.sslot || 1);
    const eslot = Number(el.dataset.eslot || sslot+1);
    // 30ë¶„ ë‹¨ìœ„ ìŠ¬ë¡¯ì„ 1ì‹œê°„ ë‹¨ìœ„ë¡œ ë³€í™˜
    const startHourSlot = Math.ceil((sslot - 1) / 2) + 1;
    const endHourSlot = Math.ceil((eslot - 1) / 2) + 1;
    const slotHeight = 40; // Step 7ì€ 40px ë†’ì´
    const top = (startHourSlot - 1) * slotHeight;
    const height = (endHourSlot - startHourSlot) * slotHeight;
    el.style.left = `calc((100%/6) * ${day+1})`;
    el.style.width = `calc(100%/6)`;
    el.style.top = `${top}px`;
    el.style.height = `${height}px`;
    el.style.background = 'rgba(59,130,246,0.9)';
  });
}

function positionAIScheduleSlots(container) {
  // containerê°€ .ai-schedule-layerì¸ ê²½ìš°ì™€ ê·¸ ë¶€ëª¨ì¸ ê²½ìš° ëª¨ë‘ ì²˜ë¦¬
  const layer = container.classList.contains('ai-schedule-layer') 
    ? container 
    : container.querySelector('.ai-schedule-layer');
  if (!layer) return;
  
  const slots = layer.querySelectorAll('.slot');
  slots.forEach(el => {
    const day = Number(el.dataset.day || 0);
    const sslot = Number(el.dataset.sslot || 1);
    const eslot = Number(el.dataset.eslot || sslot+1);
    // 30ë¶„ ë‹¨ìœ„ ìŠ¬ë¡¯ì„ 1ì‹œê°„ ë‹¨ìœ„ë¡œ ë³€í™˜
    const startHourSlot = Math.ceil((sslot - 1) / 2) + 1;
    const endHourSlot = Math.ceil((eslot - 1) / 2) + 1;
    const slotHeight = 40; // Step 7ì€ 40px ë†’ì´
    const top = (startHourSlot - 1) * slotHeight;
    const height = (endHourSlot - startHourSlot) * slotHeight;
    el.style.left = `calc((100%/6) * ${day+1})`;
    el.style.width = `calc(100%/6)`;
    el.style.top = `${top}px`;
    el.style.height = `${height}px`;
    el.style.background = 'rgba(147,51,234,0.9)'; // ë³´ë¼ìƒ‰ (AI ì¶”ì²œ)
  });
}

// Position schedule slots (step7) - 1ì‹œê°„ ë‹¨ìœ„ë¡œ ë³€í™˜
if (BOOTSTRAP && BOOTSTRAP.step === 7) {
  // ì´ˆê¸° ë¡œë“œ ì‹œ ëª¨ë“  ì‹œê°„í‘œ ìŠ¬ë¡¯ ìœ„ì¹˜ ê³„ì‚°
  setTimeout(() => {
    // ì¼ë°˜ ì‹œê°„í‘œ ìŠ¬ë¡¯ ìœ„ì¹˜ ê³„ì‚°
    document.querySelectorAll('.schedule-layer').forEach(layer => {
      // layerì˜ ë¶€ëª¨ ìš”ì†Œë¥¼ containerë¡œ ì‚¬ìš©
      const container = layer.parentElement;
      if (container) {
        positionScheduleSlots(container);
      }
    });
    // AI ì‹œê°„í‘œ ìŠ¬ë¡¯ ìœ„ì¹˜ ê³„ì‚°
    document.querySelectorAll('.ai-schedule-layer').forEach(layer => {
      // layerì˜ ë¶€ëª¨ ìš”ì†Œë¥¼ containerë¡œ ì‚¬ìš©
      const container = layer.parentElement;
      if (container) {
        positionAIScheduleSlots(container);
      }
    });
  }, 100);
}
  </script>
{% endblock %}